<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù… ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</title>
<style>
:root{
  --bg:#0b1220;
  --card:#0f1a30;
  --card2:#101f3a;
  --text:#eaf0ff;
  --muted:#a8b3d6;
  --line:rgba(255,255,255,.10);
  --green:#22c55e;
  --green2:#16a34a;
  --red:#ef4444;
  --amber:#f59e0b;
  --blue:#60a5fa;
  --shadow: 0 12px 30px rgba(0,0,0,.35);
  --radius:18px;
  --radius2:14px;
  --pad:14px;
  --font: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font);
  background: radial-gradient(1200px 600px at 80% -10%, rgba(34,197,94,.25), transparent 55%),
              radial-gradient(1000px 500px at 20% 0%, rgba(96,165,250,.20), transparent 55%),
              linear-gradient(180deg, #070b14 0%, #0b1220 60%, #070b14 100%);
  color:var(--text);
  direction:rtl;
}

a{color:inherit}
.container{max-width:1100px;margin:0 auto;padding:18px}
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid var(--line);
  box-shadow:var(--shadow);
  border-radius:var(--radius);
  padding:var(--pad);
  backdrop-filter: blur(8px);
}
.card + .card{margin-top:14px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 260px;min-width:240px}

.hdr{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:14px 16px;
  position:sticky;top:0;z-index:50;
  background: rgba(7,11,20,.65);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--line);
}
.brand{
  display:flex;align-items:center;gap:10px;min-width:0
}
.brand .logo{
  width:40px;height:40px;border-radius:12px;overflow:hidden;
  background: rgba(255,255,255,.06);
  border:1px solid var(--line);
  display:grid;place-items:center;flex:0 0 auto
}
.brand .logo img{width:100%;height:100%;object-fit:cover}
.brand .title{display:flex;flex-direction:column;min-width:0}
.brand .title b{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.brand .title span{font-size:12px;color:var(--muted)}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 10px;border-radius:999px;border:1px solid var(--line);
  background: rgba(255,255,255,.05);
  font-size:12px;color:var(--muted)
}

.tabs{
  display:flex;gap:8px;flex-wrap:wrap;margin:14px 0 0;
  position:sticky;top:78px;z-index:40;
  padding-bottom:8px;background: rgba(7,11,20,.35);backdrop-filter: blur(10px);
}
.tab{
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
  color:var(--muted);
  padding:10px 12px;border-radius:999px;
  font-size:13px;cursor:pointer;user-select:none;
  transition: transform .08s ease, background .15s ease, color .15s ease;
}
.tab:active{transform:scale(.98)}
.tab.active{
  background: rgba(34,197,94,.18);
  border-color: rgba(34,197,94,.40);
  color:var(--text);
}
.section{display:none}
.section.active{display:block}

label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input,select,textarea{
  width:100%;
  padding:12px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(15,26,48,.60);
  color:var(--text);
  outline:none;
}
input::placeholder, textarea::placeholder{color:rgba(168,179,214,.65)}
textarea{min-height:90px;resize:vertical}

.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{
  border:1px solid transparent;
  background: rgba(255,255,255,.08);
  color:var(--text);
  padding:11px 14px;border-radius:14px;
  font-size:14px;cursor:pointer;user-select:none;
  display:inline-flex;align-items:center;gap:10px;
  transition: transform .08s ease, filter .15s ease, background .15s ease, border-color .15s ease;
}
.btn:active{transform:scale(.98)}
.btn.primary{background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(22,163,74,.85));}
.btn.primary:hover{filter:brightness(1.06)}
.btn.danger{background: rgba(239,68,68,.18);border-color: rgba(239,68,68,.35)}
.btn.ghost{background: rgba(255,255,255,.04);border-color: rgba(255,255,255,.10)}
.btn.small{padding:8px 10px;border-radius:12px;font-size:12px}

.hr{height:1px;background:var(--line);margin:14px 0}
.kpi{
  display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
  border-radius:var(--radius2);
  padding:12px 12px;
}
.kpi b{font-size:14px}
.kpi span{font-size:12px;color:var(--muted)}
.kpi .v{font-size:18px;margin-top:4px}

.tableWrap{overflow:auto;border-radius:14px;border:1px solid var(--line)}
table{width:100%;border-collapse:collapse;min-width:720px;background: rgba(15,26,48,.45)}
th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;vertical-align:top}
th{position:sticky;top:0;background: rgba(7,11,20,.75);backdrop-filter: blur(8px);text-align:right;color:var(--muted);font-weight:600}
tr:hover td{background: rgba(255,255,255,.03)}

.toast{
  position:fixed;inset:auto 14px 14px 14px;z-index:999;
  display:flex;flex-direction:column;gap:8px;pointer-events:none
}
.toast .t{
  pointer-events:auto;
  padding:12px 12px;border-radius:14px;border:1px solid var(--line);
  background: rgba(7,11,20,.70);backdrop-filter: blur(10px);
  box-shadow:var(--shadow);
  display:flex;justify-content:space-between;gap:10px;align-items:flex-start
}
.toast .t.ok{border-color: rgba(34,197,94,.35)}
.toast .t.err{border-color: rgba(239,68,68,.35)}
.toast .t b{font-size:13px}
.toast .t span{font-size:12px;color:var(--muted)}
.toast .t button{
  background:transparent;border:0;color:var(--muted);cursor:pointer;font-size:16px;line-height:1
}

.footerNote{color:var(--muted);font-size:12px;line-height:1.7}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:7px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color:var(--muted);font-size:12px
}

@media (min-width:900px){
  .hdr{padding:16px 22px}
  .container{padding:22px}
  .tabs{top:82px}
}

@media print{
  body{background:#fff;color:#000}
  .noPrint{display:none !important}
  .card{box-shadow:none;border-color:#ddd;background:#fff}
  table{background:#fff}
  th{background:#f3f4f6;color:#111}
  td,th{border-bottom:1px solid #ddd}
}
</style>
</head>
<body>
  <div class="hdr noPrint">
    <div class="brand">
      <div class="logo" data-company-logo></div>
      <div class="title">
        <b data-company-name>â€”</b>
        <span>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <span class="badge" data-role>Admin</span>
      <button class="btn ghost small" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="container">

    <div class="tabs noPrint">
      <div class="tab active" data-tab="secCompany">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</div>
      <div class="tab" data-tab="secDeps">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
      <div class="tab" data-tab="secEmps">Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</div>
      <div class="tab" data-tab="secManagers">Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</div>
      <div class="tab" data-tab="secMonth">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
      <div class="tab" data-tab="secAttendance">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù…</div>
      <div class="tab" data-tab="secAdvances">Ø§Ù„Ø³Ù„Ù</div>
      <div class="tab" data-tab="secPayroll">Ø§Ù„Ø±ÙˆØ§ØªØ¨</div>
      <div class="tab" data-tab="secExcel">Excel (CSV)</div>
    </div>

    <div class="section card" id="secCompany">
      <div class="row">
        <div class="col">
          <div class="pill">ğŸ¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</div>
          <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label>
          <input id="companyName">
          <label>Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© (ØµÙˆØ±Ø©)</label>
          <input id="companyLogoFile" type="file" accept="image/*">
          <div class="btns">
            <button class="btn primary" id="saveCompanyBtn">Ø­ÙØ¸</button>
            <button class="btn danger" id="clearLogoBtn">Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±</button>
          </div>
          <div class="footerNote">Ø§Ù„Ø´Ø¹Ø§Ø± ÙŠØ¸Ù‡Ø± ÙÙŠ ØµÙƒ Ø§Ù„Ù‚Ø¨Ø¶ + ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù.</div>
        </div>
        <div class="col">
          <div class="kpi">
            <div>
              <b>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</b>
              <div><span id="statsTxt">â€”</span></div>
            </div>
            <div class="v">ğŸ“Š</div>
          </div>

          <div class="hr"></div>
          <div class="footerNote">
            * Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ± â€” Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ LocalStorage Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­.<br>
            * ÙŠÙØ¶Ù‘Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.
          </div>
        </div>
      </div>
    </div>

    <div class="section card" id="secDeps">
      <div class="pill">ğŸ§© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
      <div class="row">
        <div class="col">
          <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</label>
          <input id="depName" placeholder="Ù…Ø«Ø§Ù„: Ø¥Ø¯Ø§Ø±Ø© / Ù…Ø¨ÙŠØ¹Ø§Øª / Ø¥Ù†ØªØ§Ø¬">
          <div class="btns">
            <button class="btn primary" id="addDepBtn">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
          </div>
        </div>
        <div class="col">
          <label>Ø¨Ø­Ø«</label>
          <input id="depSearch" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
        </div>
      </div>
      <div class="hr"></div>
      <div class="tableWrap">
        <table>
          <thead><tr><th>Ø§Ù„Ù‚Ø³Ù…</th><th style="width:180px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody id="depTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="section card" id="secEmps">
      <div class="pill">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
      <div class="row">
        <div class="col">
          <label>Ø§Ù„Ø§Ø³Ù…</label>
          <input id="empNameIn">
          <label>Ø§Ù„Ù‚Ø³Ù…</label>
          <select id="empDep"></select>
          <label>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</label>
          <input id="empSalary" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 3000">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="empNote" placeholder="ÙƒÙˆØ¯/Ù…Ù„Ø§Ø­Ø¸Ø©">
          <div class="btns">
            <button class="btn primary" id="addEmpBtn">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
            <button class="btn ghost" id="resetEmpFormBtn">ØªÙØ±ÙŠØº</button>
          </div>
          <input type="hidden" id="empEditId">
        </div>
        <div class="col">
          <label>Ø¨Ø­Ø«</label>
          <input id="empSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…...">
          <div class="hr"></div>
          <div class="footerNote">Ù†ØµÙŠØ­Ø©: Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ù‹Ø§ Ø­ØªÙ‰ ÙŠØ¹Ù…Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø³Ù‡ÙˆÙ„Ø©.</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ù‚Ø³Ù…</th>
              <th>Ø§Ù„Ø±Ø§ØªØ¨</th>
              <th>Ù†Ø´Ø·</th>
              <th style="width:220px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="empTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="section card" id="secManagers">
      <div class="pill">ğŸ‘” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ (Manager)</div>
      <div class="row">
        <div class="col">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="mUser" placeholder="Ù…Ø«Ø§Ù„: manager1">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="mPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          <div class="btns">
            <button class="btn primary" id="addManagerBtn">Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ±</button>
          </div>
        </div>
        <div class="col">
          <label>Ø¨Ø­Ø«</label>
          <input id="mSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...">
        </div>
      </div>
      <div class="hr"></div>
      <div class="tableWrap">
        <table>
          <thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th style="width:180px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody id="mTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="section card" id="secMonth">
      <div class="pill">ğŸ—“ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
      <div class="row">
        <div class="col">
          <label>Ø§Ù„Ø´Ù‡Ø±</label>
          <input id="msYm" type="month">
          <label>Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø´Ù‡Ø±</label>
          <select id="msDays">
            <option value="28">28</option>
            <option value="29">29</option>
            <option value="30">30</option>
            <option value="31">31</option>
          </select>
          <label>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø´Ù‡Ø±</label>
          <input id="msWorkHours" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 240">
        </div>
        <div class="col">
          <label>ÙˆÙ‚Øª Ø§Ù„Ø¯ÙˆØ§Ù… (Ù…Ù†)</label>
          <input id="msStart" type="time" value="09:00">
          <label>ÙˆÙ‚Øª Ø§Ù„Ø¯ÙˆØ§Ù… (Ø¥Ù„Ù‰)</label>
          <input id="msEnd" type="time" value="17:00">
          <label>Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ØªØ£Ø®ÙŠØ± (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
          <input id="msLateGrace" type="number" value="10">
          <label>Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ± (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
          <input id="msEarlyGrace" type="number" value="10">
        </div>
        <div class="col">
          <label>Ù…Ø¹Ø§Ù…Ù„ Ø®ØµÙ… Ø§Ù„ØªØ£Ø®ÙŠØ±</label>
          <input id="msLateMul" type="number" inputmode="decimal" value="1.5" step="0.1">
          <label>Ù…Ø¹Ø§Ù…Ù„ Ø®ØµÙ… Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ±</label>
          <input id="msEarlyMul" type="number" inputmode="decimal" value="1.0" step="0.1">
          <label>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</label>
          <input id="msOtMul" type="number" inputmode="decimal" value="1.25" step="0.1">
        </div>
      </div>
      <div class="btns">
        <button class="btn primary" id="saveMonthBtn">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</button>
        <button class="btn danger" id="deleteMonthBtn">Ø­Ø°Ù Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</button>
      </div>
      <div class="footerNote">ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø± Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù… Ù„ØªØ¹Ù…Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
    </div>

    <div class="section card" id="secAttendance">
      <div class="pill">ğŸ•’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù… + Ø§Ù„Ø£Ø¹Ø°Ø§Ø±/Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª</div>
      <div class="row">
        <div class="col">
          <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
          <select id="attEmp"></select>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="attDate" type="date">
          <label>Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
          <input id="attIn" type="time">
          <label>Ø§Ù„Ø®Ø±ÙˆØ¬</label>
          <input id="attOut" type="time">
        </div>
        <div class="col">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø°Ø± / Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡</label>
          <select id="attExcuse">
            <option value="none">Ø¨Ø¯ÙˆÙ†</option>
            <option value="late_excused">ØªØ£Ø®ÙŠØ± Ø¨Ø¹Ø°Ø±</option>
            <option value="early_excused">Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ± Ø¨Ø¹Ø°Ø±</option>
            <option value="absent_excused">ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±</option>
          </select>

          <label>Ù…Ø´ÙˆØ§Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙ†Ø¹</label>
          <select id="attOutFactory">
            <option value="false">Ù„Ø§</option>
            <option value="true">Ù†Ø¹Ù…</option>
          </select>

          <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
          <textarea id="attNote" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>

          <div class="btns">
            <button class="btn primary" id="saveAttBtn">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
            <button class="btn danger" id="delAttBtn">Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„</button>
          </div>

          <div class="hr"></div>
          <div class="kpi">
            <div>
              <b>Ø§Ø­ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ</b>
              <div><span id="attCalcTxt">â€”</span></div>
            </div>
            <div class="v">âš™ï¸</div>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <div class="col">
          <label>Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª ÙŠÙˆÙ…</label>
          <input id="attListDate" type="date">
        </div>
        <div class="col">
          <label>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…)</label>
          <input id="attListSearch" placeholder="Ø§ÙƒØªØ¨...">
        </div>
      </div>

      <div class="hr"></div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
              <th>Ø§Ù„Ø®Ø±ÙˆØ¬</th>
              <th>Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</th>
              <th>Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
              <th>Ù…Ø¨ÙƒØ±</th>
              <th>Ø¹Ø°Ø±</th>
              <th>Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙ†Ø¹</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
              <th style="width:120px">Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody id="attTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="section card" id="secAdvances">
      <div class="pill">ğŸ’³ Ø§Ù„Ø³Ù„Ù</div>
      <div class="row">
        <div class="col">
          <label>Ø§Ù„Ø´Ù‡Ø±</label>
          <input id="advYm" type="month">
        </div>
        <div class="col">
          <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
          <select id="advEmp"></select>
        </div>
        <div class="col">
          <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
          <input id="advAmount" type="number" inputmode="decimal">
        </div>
      </div>
      <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
      <input id="advNote">
      <div class="btns">
        <button class="btn primary" id="saveAdvBtn">Ø­ÙØ¸ Ø§Ù„Ø³Ù„ÙØ©</button>
      </div>
      <div class="footerNote">Ø§Ù„Ø³Ù„Ù ØªØ®Øµ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙˆØªÙØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.</div>
    </div>

    <div class="section card" id="secPayroll">
      <div class="pill">ğŸ’° Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
      <div class="row">
        <div class="col">
          <label>Ø§Ù„Ø´Ù‡Ø±</label>
          <input id="payYm" type="month">
        </div>
        <div class="col">
          <label>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label>
          <input id="paySearch" placeholder="Ø§ÙƒØªØ¨...">
        </div>
        <div class="col">
          <label>ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø±ÙˆØ§ØªØ¨ (CSV)</label>
          <div class="btns">
            <button class="btn primary" id="exportPayrollBtn">ØªØµØ¯ÙŠØ±</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ù„Ù‚Ø³Ù…</th>
              <th>Ø§Ù„Ø±Ø§ØªØ¨</th>
              <th>Ø¥Ø¶Ø§ÙÙŠ (Ø³)</th>
              <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</th>
              <th>ØªØ£Ø®ÙŠØ± (Ø³)</th>
              <th>Ø®ØµÙ… Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
              <th>Ù…Ø¨ÙƒØ± (Ø³)</th>
              <th>Ø®ØµÙ… Ø§Ù„Ù…Ø¨ÙƒØ±</th>
              <th>Ø§Ù„Ø³Ù„Ù</th>
              <th>Ø§Ù„Ù…Ø³ØªØ­Ù‚</th>
              <th style="width:160px">Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody id="payTbody"></tbody>
        </table>
      </div>
      <div class="footerNote">Ø²Ø± "ØµÙƒ Ù‚Ø¨Ø¶" ÙŠÙØªØ­ Ù†Ø§ÙØ°Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF.</div>
    </div>

    <div class="section card" id="secExcel">
      <div class="pill">ğŸ“ Excel Import/Export (CSV)</div>
      <div class="row">
        <div class="col">
          <div class="kpi">
            <div>
              <b>ØªØµØ¯ÙŠØ± Ù‚ÙˆØ§Ù„Ø¨</b>
              <div><span>ØªØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ Excel Ø¨Ø³Ù‡ÙˆÙ„Ø© (CSV).</span></div>
            </div>
            <div class="v">â¬‡ï¸</div>
          </div>
          <div class="btns">
            <button class="btn primary" id="tplEmployeesBtn">Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
            <button class="btn primary" id="tplAttendanceBtn">Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ§Ù…</button>
          </div>
          <div class="btns">
            <button class="btn ghost" id="backupBtn">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (JSON)</button>
          </div>
        </div>
        <div class="col">
          <div class="kpi">
            <div>
              <b>Ø§Ø³ØªÙŠØ±Ø§Ø¯</b>
              <div><span>CSV Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø£Ùˆ Ø§Ù„Ø¯ÙˆØ§Ù… + Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© JSON.</span></div>
            </div>
            <div class="v">â¬†ï¸</div>
          </div>

          <label>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† (CSV)</label>
          <input id="impEmployees" type="file" accept=".csv,text/csv">

          <label>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯ÙˆØ§Ù… (CSV)</label>
          <input id="impAttendance" type="file" accept=".csv,text/csv">

          <label>Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© (JSON)</label>
          <input id="impBackup" type="file" accept=".json,application/json">
        </div>
      </div>

      <div class="hr"></div>
      <div class="footerNote">
        Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ù…ÙˆØ¸ÙÙŠÙ†): Ø§Ù„Ø§Ø³Ù…, Ø§Ù„Ù‚Ø³Ù…, Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ, Ù…Ù„Ø§Ø­Ø¸Ø©<br>
        Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø¯ÙˆØ§Ù…): Ø§Ù„ØªØ§Ø±ÙŠØ®, Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù, Ø§Ù„Ø¯Ø®ÙˆÙ„, Ø§Ù„Ø®Ø±ÙˆØ¬, Ø¹Ø°Ø±, Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø°Ø±, Ù…Ø´ÙˆØ§Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙ†Ø¹, Ù…Ù„Ø§Ø­Ø¸Ø©
      </div>
    </div>

    <div class="toast"></div>
  </div>

<script>
const APP_KEY = "payrollApp_v1";
const SESSION_KEY = "payrollSession_v1";

function nowISODate(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function ymFromDateStr(dateStr){ return dateStr.slice(0,7); }
function fmtMoney(n){ 
  n = Number(n||0);
  return new Intl.NumberFormat("ar-EG",{maximumFractionDigits:2}).format(n);
}
function pad2(n){ return String(n).padStart(2,"0"); }
function minutesToHM(min){
  min = Math.max(0, Math.round(min||0));
  const h = Math.floor(min/60);
  const m = min%60;
  return `${h}:${pad2(m)}`;
}
function hmToMinutes(hm){
  if(!hm) return null;
  const m = /^(\d{1,2}):(\d{2})$/.exec(hm.trim());
  if(!m) return null;
  return (+m[1])*60 + (+m[2]);
}
function clamp(n,a,b){ return Math.min(b, Math.max(a,n)); }

function toast(type, title, msg){
  const wrap = document.querySelector(".toast");
  if(!wrap) return alert(`${title}\n${msg||""}`);
  const el = document.createElement("div");
  el.className = `t ${type==="ok"?"ok":"err"}`;
  el.innerHTML = `
    <div>
      <b>${escapeHtml(title)}</b>
      <div><span>${escapeHtml(msg||"")}</span></div>
    </div>
    <button aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
  `;
  el.querySelector("button").onclick = ()=> el.remove();
  wrap.appendChild(el);
  setTimeout(()=>{ if(el.isConnected) el.remove(); }, 5200);
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function loadDB(){
  const raw = localStorage.getItem(APP_KEY);
  if(!raw){
    const init = {
      version:1,
      company:{companyName:"", companyLogo:""},
      departments:[],
      employees:[],
      managers:[],
      monthSettings:{},
      attendance:{}, // { "YYYY-MM-DD": { "empId": record } }
      advances:{} // { "YYYY-MM": { "empId": {amount,note} } }
    };
    localStorage.setItem(APP_KEY, JSON.stringify(init));
    return init;
  }
  try{ return JSON.parse(raw); }catch(e){
    console.error(e);
    localStorage.removeItem(APP_KEY);
    return loadDB();
  }
}
function saveDB(db){ localStorage.setItem(APP_KEY, JSON.stringify(db)); }
function uid(prefix="id"){
  return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
}

function getSession(){
  const raw = localStorage.getItem(SESSION_KEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}
function setSession(obj){ localStorage.setItem(SESSION_KEY, JSON.stringify(obj)); }
function clearSession(){ localStorage.removeItem(SESSION_KEY); }

function requireAuth(allowedRoles){
  const s = getSession();
  if(!s || !allowedRoles.includes(s.role)){
    window.location.href = "index.html";
    return null;
  }
  return s;
}

function setBrand(db, roleLabel){
  const name = db.company.companyName || "Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ù… ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨";
  const logo = db.company.companyLogo || "";
  const elName = document.querySelector("[data-company-name]");
  const elLogo = document.querySelector("[data-company-logo]");
  const elRole = document.querySelector("[data-role]");
  if(elName) elName.textContent = name;
  if(elRole) elRole.textContent = roleLabel;
  if(elLogo){
    if(logo){
      elLogo.innerHTML = `<img alt="Ø´Ø¹Ø§Ø±" src="${logo}">`;
    }else{
      elLogo.innerHTML = `<span style="font-weight:800;color:rgba(255,255,255,.65)">ğŸŸ©</span>`;
    }
  }
}

function wireTabs(){
  const tabs = [...document.querySelectorAll(".tab")];
  const sections = [...document.querySelectorAll(".section")];
  tabs.forEach(t=>{
    t.addEventListener("click", ()=>{
      const id = t.getAttribute("data-tab");
      tabs.forEach(x=>x.classList.toggle("active", x===t));
      sections.forEach(s=>s.classList.toggle("active", s.id===id));
      window.scrollTo({top:0,behavior:"smooth"});
    });
  });
  const first = tabs.find(t=>t.classList.contains("active")) || tabs[0];
  if(first) first.click();
}

function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function downloadCSV(filename, rows){
  const csv = rows.map(r=> r.map(v=>{
    const s = String(v ?? "");
    const needs = /[",\n\r]/.test(s);
    return needs ? `"${s.replaceAll('"','""')}"` : s;
  }).join(",")).join("\r\n");
  downloadText(filename, "\ufeff"+csv);
}
function parseCSV(text){
  const rows = [];
  let i=0, cur="", row=[], inQ=false;
  while(i < text.length){
    const ch = text[i];
    if(inQ){
      if(ch === '"'){
        if(text[i+1] === '"'){ cur+='"'; i+=2; continue; }
        inQ=false; i++; continue;
      }else{ cur+=ch; i++; continue; }
    }else{
      if(ch === '"'){ inQ=true; i++; continue; }
      if(ch === ','){ row.push(cur); cur=""; i++; continue; }
      if(ch === '\n'){
        row.push(cur); cur="";
        rows.push(row); row=[];
        i++; continue;
      }
      if(ch === '\r'){ i++; continue; }
      cur+=ch; i++; continue;
    }
  }
  row.push(cur);
  if(row.length>1 || row[0]!=="" ) rows.push(row);
  return rows;
}

function weekdayAr(dateStr){
  const d = new Date(dateStr+"T00:00:00");
  const names = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
  return names[d.getDay()];
}

function getMonthSetting(db, ym){
  return db.monthSettings?.[ym] || null;
}
function inferDaysInMonth(ym){
  const [y,m] = ym.split("-").map(Number);
  return new Date(y, m, 0).getDate();
}

function computeDerived(db, dateStr, empId, checkIn, checkOut, excuseType){
  const ym = ymFromDateStr(dateStr);
  const ms = getMonthSetting(db, ym);
  if(!ms) return {lateMinutes:0, earlyLeaveMinutes:0, overtimeMinutes:0, warn:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±"};
  const shiftStartM = hmToMinutes(ms.shiftStart);
  const shiftEndM = hmToMinutes(ms.shiftEnd);
  const inM = hmToMinutes(checkIn);
  const outM = hmToMinutes(checkOut);

  let late=0, early=0, ot=0;
  if(inM != null && shiftStartM != null){
    const grace = Number(ms.lateGraceMinutes||0);
    late = Math.max(0, inM - (shiftStartM + grace));
  }
  if(outM != null && shiftEndM != null){
    const graceE = Number(ms.earlyLeaveGraceMinutes||0);
    early = Math.max(0, (shiftEndM - graceE) - outM);
    ot = Math.max(0, outM - shiftEndM);
  }
  if(excuseType === "late_excused") late = 0;
  if(excuseType === "early_excused") early = 0;
  if(excuseType === "absent_excused"){ late=0; early=0; ot=0; }
  return {lateMinutes:Math.round(late), earlyLeaveMinutes:Math.round(early), overtimeMinutes:Math.round(ot), warn:null};
}

function getAttendanceRecord(db, dateStr, empId){
  return db.attendance?.[dateStr]?.[empId] || null;
}
function setAttendanceRecord(db, dateStr, empId, rec){
  if(!db.attendance[dateStr]) db.attendance[dateStr] = {};
  db.attendance[dateStr][empId] = rec;
}
function deleteAttendanceRecord(db, dateStr, empId){
  if(db.attendance?.[dateStr]?.[empId]) delete db.attendance[dateStr][empId];
  if(db.attendance?.[dateStr] && Object.keys(db.attendance[dateStr]).length===0) delete db.attendance[dateStr];
}

function getAdvance(db, ym, empId){
  return db.advances?.[ym]?.[empId] || {amount:0,note:""};
}
function setAdvance(db, ym, empId, obj){
  if(!db.advances[ym]) db.advances[ym] = {};
  db.advances[ym][empId] = {amount:Number(obj.amount||0), note:String(obj.note||"")};
}

function calcPayrollForEmployee(db, ym, emp){
  const ms = getMonthSetting(db, ym);
  const days = ms?.daysInMonth ? Number(ms.daysInMonth) : inferDaysInMonth(ym);
  const workHours = Number(ms?.workHoursInMonth||0);
  const hourValue = workHours>0 ? (Number(emp.monthlySalary||0)/workHours) : 0;

  const multipliers = {
    late: Number(ms?.latePenaltyMultiplier || 1.5),
    early: Number(ms?.earlyPenaltyMultiplier || 1.0),
    ot: Number(ms?.overtimeMultiplier || 1.0),
  };

  let totalLateMin=0, totalEarlyMin=0, totalOtMin=0;
  for(let d=1; d<=days; d++){
    const dateStr = `${ym}-${pad2(d)}`;
    const r = getAttendanceRecord(db, dateStr, emp.id);
    if(r){
      totalLateMin += Number(r.lateMinutes||0);
      totalEarlyMin += Number(r.earlyLeaveMinutes||0);
      totalOtMin += Number(r.overtimeMinutes||0);
    }
  }

  const lateDeduction = (totalLateMin/60)*hourValue*multipliers.late;
  const earlyDeduction = (totalEarlyMin/60)*hourValue*multipliers.early;
  const otValue = (totalOtMin/60)*hourValue*multipliers.ot;

  const adv = getAdvance(db, ym, emp.id);
  const advances = Number(adv.amount||0);

  const net = Number(emp.monthlySalary||0) + otValue - lateDeduction - earlyDeduction - advances;

  return {
    ym, days, workHours, hourValue,
    totalLateMin, totalEarlyMin, totalOtMin,
    lateDeduction, earlyDeduction, otValue,
    advances, net, multipliers
  };
}

function openPayslipPrintWindow(db, ym, emp){
  const dep = db.departments.find(d=>d.id===emp.departmentId);
  const depName = dep ? dep.name : "â€”";
  const ms = getMonthSetting(db, ym);
  const days = ms?.daysInMonth ? Number(ms.daysInMonth) : inferDaysInMonth(ym);
  const logo = db.company.companyLogo || "";
  const company = db.company.companyName || "â€”";

  const pay = calcPayrollForEmployee(db, ym, emp);

  const rows = [];
  for(let d=1; d<=days; d++){
    const dateStr = `${ym}-${pad2(d)}`;
    const r = getAttendanceRecord(db, dateStr, emp.id);
    if(r){
      rows.push(`
        <tr>
          <td>${escapeHtml(dateStr)}</td>
          <td>${escapeHtml(weekdayAr(dateStr))}</td>
          <td>${escapeHtml(r.checkIn||"")}</td>
          <td>${escapeHtml(r.checkOut||"")}</td>
          <td>${escapeHtml(minutesToHM(r.overtimeMinutes||0))}</td>
          <td>${escapeHtml(minutesToHM(r.lateMinutes||0))}</td>
          <td>${escapeHtml(minutesToHM(r.earlyLeaveMinutes||0))}</td>
        </tr>
      `);
    }
  }

  const html = `
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ØµÙƒ Ù‚Ø¨Ø¶ - ${escapeHtml(emp.name)}</title>
<style>
  body{font-family:Tahoma,Arial,sans-serif;margin:0;background:#fff;color:#111}
  .page{padding:24px 28px}
  .top{display:flex;align-items:center;justify-content:space-between;gap:16px;border-bottom:2px solid #111;padding-bottom:14px}
  .logo{width:60px;height:60px;border:1px solid #ddd;border-radius:12px;overflow:hidden;display:grid;place-items:center}
  .logo img{width:100%;height:100%;object-fit:cover}
  h1{margin:0;font-size:20px}
  .meta{margin-top:8px;color:#333;font-size:13px;line-height:1.7}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{border:1px solid #ddd;padding:8px;font-size:12px;text-align:right}
  th{background:#f3f4f6}
  .sum{margin-top:14px;border:1px solid #ddd;border-radius:10px;padding:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .line{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #e5e7eb}
  .line:last-child{border-bottom:0}
  .sig{display:flex;justify-content:space-between;margin-top:26px}
  .sig .box{width:46%;border-top:1px solid #111;padding-top:10px;text-align:center;font-size:13px}
  @media print{ .noPrint{display:none} .page{padding:14mm} }
</style>
</head>
<body>
  <div class="page">
    <div class="top">
      <div class="logo">${logo?`<img src="${logo}" alt="Ø´Ø¹Ø§Ø±">`:""}</div>
      <div style="flex:1">
        <h1>${escapeHtml(company)} â€” ØµÙƒ Ù‚Ø¨Ø¶ Ø±Ø§ØªØ¨</h1>
        <div class="meta">
          <div><b>Ø§Ù„Ù…ÙˆØ¸Ù:</b> ${escapeHtml(emp.name)} â€” <b>Ø§Ù„Ù‚Ø³Ù…:</b> ${escapeHtml(depName)}</div>
          <div><b>Ø§Ù„Ø´Ù‡Ø±:</b> ${escapeHtml(ym)}</div>
        </div>
      </div>
      <button class="noPrint" onclick="window.print()" style="padding:10px 14px;border:1px solid #111;background:#111;color:#fff;border-radius:10px;cursor:pointer">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„ÙŠÙˆÙ…</th>
          <th>Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
          <th>Ø§Ù„Ø®Ø±ÙˆØ¬</th>
          <th>Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</th>
          <th>Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
          <th>Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ±</th>
        </tr>
      </thead>
      <tbody>
        ${rows.join("") || `<tr><td colspan="7" style="text-align:center;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</td></tr>`}
      </tbody>
    </table>

    <div class="sum">
      <div class="grid">
        <div class="line"><span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</span><b>${minutesToHM(pay.totalOtMin)} â€” ${fmtMoney(pay.otValue)}</b></div>
        <div class="line"><span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ£Ø®ÙŠØ±</span><b>${minutesToHM(pay.totalLateMin)} â€” ${fmtMoney(pay.lateDeduction)}</b></div>
        <div class="line"><span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ±</span><b>${minutesToHM(pay.totalEarlyMin)} â€” ${fmtMoney(pay.earlyDeduction)}</b></div>
        <div class="line"><span>Ø§Ù„Ø³Ù„Ù</span><b>${fmtMoney(pay.advances)}</b></div>
        <div class="line" style="grid-column:1/-1;border-top:1px solid #e5e7eb;padding-top:10px">
          <span><b>Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</b></span><b style="font-size:16px">${fmtMoney(pay.net)}</b>
        </div>
      </div>
    </div>

    <div class="sig">
      <div class="box">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù</div>
      <div class="box">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
    </div>
  </div>
</body>
</html>
  `.trim();

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

function ensureSeedData(db){
  if(db.departments.length===0 && db.employees.length===0 && db.managers.length===0 && !db.company.companyName){
    db.company.companyName = "Ø´Ø±ÙƒØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ©";
    const depId = uid("dep");
    db.departments.push({id:depId, name:"Ø¥Ø¯Ø§Ø±Ø©"});
    db.employees.push({id:uid("emp"), name:"Ù…ÙˆØ¸Ù ØªØ¬Ø±ÙŠØ¨ÙŠ", departmentId:depId, monthlySalary:3000, active:true, notes:""});
    const ym = nowISODate().slice(0,7);
    db.monthSettings[ym] = {
      daysInMonth: inferDaysInMonth(ym),
      workHoursInMonth: 240,
      shiftStart:"09:00",
      shiftEnd:"17:00",
      lateGraceMinutes:10,
      earlyLeaveGraceMinutes:10,
      latePenaltyMultiplier:1.5,
      earlyPenaltyMultiplier:1.0,
      overtimeMultiplier:1.25
    };
    saveDB(db);
  }
}
</script>
<script>
(function(){
  requireAuth(["admin"]);
  const db = loadDB();
  setBrand(db, "Admin");
  wireTabs();

  // Defaults
  document.getElementById("attDate").value = nowISODate();
  document.getElementById("attListDate").value = nowISODate();
  document.getElementById("msYm").value = nowISODate().slice(0,7);
  document.getElementById("advYm").value = nowISODate().slice(0,7);
  document.getElementById("payYm").value = nowISODate().slice(0,7);

  document.getElementById("logoutBtn").onclick = ()=>{ clearSession(); location.href="index.html"; };

  // Company
  const companyName = document.getElementById("companyName");
  companyName.value = db.company.companyName || "";
  updateStats();

  document.getElementById("saveCompanyBtn").onclick = async ()=>{
    db.company.companyName = companyName.value.trim();
    const file = document.getElementById("companyLogoFile").files[0];
    if(file){
      const b64 = await fileToDataURL(file);
      db.company.companyLogo = b64;
    }
    saveDB(db);
    setBrand(db, "Admin");
    toast("ok","ØªÙ… Ø§Ù„Ø­ÙØ¸","ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©.");
    updateStats();
  };
  document.getElementById("clearLogoBtn").onclick = ()=>{
    db.company.companyLogo = "";
    saveDB(db);
    setBrand(db, "Admin");
    toast("ok","ØªÙ…","ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø¹Ø§Ø±.");
  };

  async function fileToDataURL(file){
    return await new Promise((res,rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(String(r.result));
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  function updateStats(){
    const statsTxt = document.getElementById("statsTxt");
    const months = Object.keys(db.monthSettings||{}).length;
    const attDays = Object.keys(db.attendance||{}).length;
    statsTxt.textContent = `${db.employees.length} Ù…ÙˆØ¸Ù â€” ${db.departments.length} Ù‚Ø³Ù… â€” ${db.managers.length} Ù…Ø¯ÙŠØ± â€” ${months} Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ù‡Ø± â€” ${attDays} ÙŠÙˆÙ… Ø­Ø¶ÙˆØ±`;
  }

  // Departments
  document.getElementById("addDepBtn").onclick = ()=>{
    const name = document.getElementById("depName").value.trim();
    if(!name){ toast("err","Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…",""); return; }
    if(db.departments.some(d=>d.name===name)){ toast("err","Ø§Ù„Ù‚Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯",""); return; }
    db.departments.push({id:uid("dep"), name});
    saveDB(db);
    document.getElementById("depName").value="";
    renderDeps();
    renderEmpDepOptions();
    updateStats();
    toast("ok","ØªÙ…","ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù….");
  };
  document.getElementById("depSearch").oninput = renderDeps;

  function renderDeps(){
    const q = document.getElementById("depSearch").value.trim();
    const tbody = document.getElementById("depTbody");
    tbody.innerHTML = "";
    db.departments
      .filter(d=> !q || d.name.includes(q))
      .sort((a,b)=>a.name.localeCompare(b.name,'ar'))
      .forEach(d=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(d.name)}</td>
          <td>
            <button class="btn small" data-edit>ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn small danger" data-del>Ø­Ø°Ù</button>
          </td>
        `;
        tr.querySelector("[data-edit]").onclick = ()=>{
          const nn = prompt("Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", d.name);
          if(!nn) return;
          const name = nn.trim();
          if(!name) return;
          if(db.departments.some(x=>x.name===name && x.id!==d.id)){ toast("err","Ø§Ø³Ù… Ù…ÙƒØ±Ø±",""); return; }
          d.name = name;
          saveDB(db);
          renderDeps(); renderEmpDepOptions(); renderEmployees(); renderPayroll();
          toast("ok","ØªÙ…","ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù….");
        };
        tr.querySelector("[data-del]").onclick = ()=>{
          const used = db.employees.some(e=>e.departmentId===d.id);
          if(used){ toast("err","Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°Ù","Ù‡Ù†Ø§Ùƒ Ù…ÙˆØ¸ÙÙˆÙ† Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…."); return; }
          if(!confirm("Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…ØŸ")) return;
          db.departments = db.departments.filter(x=>x.id!==d.id);
          saveDB(db);
          renderDeps(); renderEmpDepOptions();
          updateStats();
          toast("ok","ØªÙ…","ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù….");
        };
        tbody.appendChild(tr);
      });
  }

  // Employees
  function renderEmpDepOptions(){
    const sel = document.getElementById("empDep");
    sel.innerHTML = "";
    db.departments
      .sort((a,b)=>a.name.localeCompare(b.name,'ar'))
      .forEach(d=>{
        const o = document.createElement("option");
        o.value = d.id; o.textContent = d.name;
        sel.appendChild(o);
      });
    if(db.departments.length===0){
      const o = document.createElement("option");
      o.value=""; o.textContent="â€” Ø£Ø¶Ù Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹ â€”";
      sel.appendChild(o);
    }
  }

  document.getElementById("addEmpBtn").onclick = ()=>{
    const name = document.getElementById("empNameIn").value.trim();
    const depId = document.getElementById("empDep").value;
    const salary = Number(document.getElementById("empSalary").value||0);
    const notes = document.getElementById("empNote").value.trim();
    if(!name){ toast("err","Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",""); return; }
    if(!depId){ toast("err","Ø§Ø®ØªØ± Ù‚Ø³Ù…",""); return; }
    if(salary<=0){ toast("err","Ø±Ø§ØªØ¨ ØºÙŠØ± ØµØ­ÙŠØ­",""); return; }
    const editId = document.getElementById("empEditId").value;

    if(editId){
      const emp = db.employees.find(e=>e.id===editId);
      if(!emp){ toast("err","ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯",""); return; }
      if(db.employees.some(e=>e.name===name && e.id!==editId)){ toast("err","Ø§Ø³Ù… Ù…ÙƒØ±Ø±",""); return; }
      emp.name=name; emp.departmentId=depId; emp.monthlySalary=salary; emp.notes=notes;
      saveDB(db);
      resetEmpForm();
      renderEmployees(); renderAttendanceSelectors(); renderPayroll();
      updateStats();
      toast("ok","ØªÙ…","ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù.");
    }else{
      if(db.employees.some(e=>e.name===name)){ toast("err","Ø§Ø³Ù… Ù…ÙƒØ±Ø±",""); return; }
      db.employees.push({id:uid("emp"), name, departmentId:depId, monthlySalary:salary, active:true, notes});
      saveDB(db);
      resetEmpForm();
      renderEmployees(); renderAttendanceSelectors(); renderPayroll();
      updateStats();
      toast("ok","ØªÙ…","ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù.");
    }
  };
  document.getElementById("resetEmpFormBtn").onclick = resetEmpForm;
  document.getElementById("empSearch").oninput = renderEmployees;

  function resetEmpForm(){
    document.getElementById("empNameIn").value="";
    document.getElementById("empSalary").value="";
    document.getElementById("empNote").value="";
    document.getElementById("empEditId").value="";
  }

  function depNameById(id){
    const d = db.departments.find(x=>x.id===id);
    return d?d.name:"â€”";
  }

  function renderEmployees(){
    const q = document.getElementById("empSearch").value.trim();
    const tbody = document.getElementById("empTbody");
    tbody.innerHTML = "";
    db.employees
      .filter(e=> !q || e.name.includes(q))
      .sort((a,b)=>a.name.localeCompare(b.name,'ar'))
      .forEach(e=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(e.name)}</td>
          <td>${escapeHtml(depNameById(e.departmentId))}</td>
          <td>${fmtMoney(e.monthlySalary)}</td>
          <td>${e.active===false ? "Ù„Ø§" : "Ù†Ø¹Ù…"}</td>
          <td>
            <button class="btn small" data-edit>ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn small" data-toggle>${e.active===false?"ØªÙØ¹ÙŠÙ„":"ØªØ¹Ø·ÙŠÙ„"}</button>
            <button class="btn small danger" data-del>Ø­Ø°Ù</button>
          </td>
        `;
        tr.querySelector("[data-edit]").onclick = ()=>{
          document.getElementById("empNameIn").value = e.name;
          document.getElementById("empDep").value = e.departmentId;
          document.getElementById("empSalary").value = e.monthlySalary;
          document.getElementById("empNote").value = e.notes||"";
          document.getElementById("empEditId").value = e.id;
          toast("ok","ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„","Ø¹Ø¯Ù‘Ù„ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù.");
        };
        tr.querySelector("[data-toggle]").onclick = ()=>{
          e.active = (e.active===false) ? true : false;
          saveDB(db);
          renderEmployees(); renderAttendanceSelectors(); renderPayroll();
          toast("ok","ØªÙ…","ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸Ù.");
        };
        tr.querySelector("[data-del]").onclick = ()=>{
          if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ (ÙˆÙ„Ø§ ÙŠØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§).")) return;
          db.employees = db.employees.filter(x=>x.id!==e.id);
          saveDB(db);
          renderEmployees(); renderAttendanceSelectors(); renderPayroll();
          updateStats();
          toast("ok","ØªÙ…","ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù.");
        };
        tbody.appendChild(tr);
      });
  }

  // Managers
  document.getElementById("addManagerBtn").onclick = ()=>{
    const u = document.getElementById("mUser").value.trim();
    const p = document.getElementById("mPass").value;
    if(!u || !p){ toast("err","Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",""); return; }
    if(db.managers.some(m=>m.username===u)){ toast("err","Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙƒØ±Ø±",""); return; }
    db.managers.push({id:uid("mgr"), username:u, password:p});
    saveDB(db);
    document.getElementById("mUser").value="";
    document.getElementById("mPass").value="";
    renderManagers();
    updateStats();
    toast("ok","ØªÙ…","ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ±.");
  };
  document.getElementById("mSearch").oninput = renderManagers;

  function renderManagers(){
    const q = document.getElementById("mSearch").value.trim();
    const tbody = document.getElementById("mTbody");
    tbody.innerHTML = "";
    db.managers
      .filter(m=>!q || m.username.includes(q))
      .sort((a,b)=>a.username.localeCompare(b.username))
      .forEach(m=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(m.username)}</td>
          <td>
            <button class="btn small" data-reset>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
            <button class="btn small danger" data-del>Ø­Ø°Ù</button>
          </td>
        `;
        tr.querySelector("[data-reset]").onclick = ()=>{
          const np = prompt("ÙƒÙ„Ù…Ø© Ø³Ø± Ø¬Ø¯ÙŠØ¯Ø©:", "");
          if(!np) return;
          m.password = np;
          saveDB(db);
          toast("ok","ØªÙ…","ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.");
        };
        tr.querySelector("[data-del]").onclick = ()=>{
          if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙŠØ±ØŸ")) return;
          db.managers = db.managers.filter(x=>x.id!==m.id);
          saveDB(db);
          renderManagers();
          updateStats();
          toast("ok","ØªÙ…","ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙŠØ±.");
        };
        tbody.appendChild(tr);
      });
  }

  // Month settings
  const msYm = document.getElementById("msYm");
  msYm.addEventListener("change", loadMonthForm);
  document.getElementById("saveMonthBtn").onclick = ()=>{
    const ym = msYm.value;
    if(!ym){ toast("err","Ø§Ø®ØªØ± Ø´Ù‡Ø±",""); return; }
    db.monthSettings[ym] = {
      daysInMonth: Number(document.getElementById("msDays").value),
      workHoursInMonth: Number(document.getElementById("msWorkHours").value||0),
      shiftStart: document.getElementById("msStart").value || "09:00",
      shiftEnd: document.getElementById("msEnd").value || "17:00",
      lateGraceMinutes: Number(document.getElementById("msLateGrace").value||0),
      earlyLeaveGraceMinutes: Number(document.getElementById("msEarlyGrace").value||0),
      latePenaltyMultiplier: Number(document.getElementById("msLateMul").value||1.5),
      earlyPenaltyMultiplier: Number(document.getElementById("msEarlyMul").value||1.0),
      overtimeMultiplier: Number(document.getElementById("msOtMul").value||1.0),
    };
    saveDB(db);
    toast("ok","ØªÙ… Ø§Ù„Ø­ÙØ¸","ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±.");
    updateStats();
    renderPayroll();
    updateAttendanceCalcPreview();
  };
  document.getElementById("deleteMonthBtn").onclick = ()=>{
    const ym = msYm.value;
    if(!ym) return;
    if(!confirm("Ø­Ø°Ù Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ")) return;
    delete db.monthSettings[ym];
    saveDB(db);
    toast("ok","ØªÙ…","ØªÙ… Ø­Ø°Ù Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±.");
    updateStats();
    loadMonthForm();
    renderPayroll();
  };

  function loadMonthForm(){
    const ym = msYm.value;
    const ms = db.monthSettings[ym];
    if(ms){
      document.getElementById("msDays").value = String(ms.daysInMonth||inferDaysInMonth(ym));
      document.getElementById("msWorkHours").value = ms.workHoursInMonth||"";
      document.getElementById("msStart").value = ms.shiftStart||"09:00";
      document.getElementById("msEnd").value = ms.shiftEnd||"17:00";
      document.getElementById("msLateGrace").value = ms.lateGraceMinutes||0;
      document.getElementById("msEarlyGrace").value = ms.earlyLeaveGraceMinutes||0;
      document.getElementById("msLateMul").value = ms.latePenaltyMultiplier||1.5;
      document.getElementById("msEarlyMul").value = ms.earlyPenaltyMultiplier||1.0;
      document.getElementById("msOtMul").value = ms.overtimeMultiplier||1.0;
    }else{
      document.getElementById("msDays").value = String(inferDaysInMonth(ym));
      document.getElementById("msWorkHours").value = "";
      document.getElementById("msStart").value = "09:00";
      document.getElementById("msEnd").value = "17:00";
      document.getElementById("msLateGrace").value = 10;
      document.getElementById("msEarlyGrace").value = 10;
      document.getElementById("msLateMul").value = 1.5;
      document.getElementById("msEarlyMul").value = 1.0;
      document.getElementById("msOtMul").value = 1.25;
    }
  }

  // Attendance
  const attEmp = document.getElementById("attEmp");
  const advEmp = document.getElementById("advEmp");
  const attListDate = document.getElementById("attListDate");
  const attListSearch = document.getElementById("attListSearch");
  const attDate = document.getElementById("attDate");
  const attIn = document.getElementById("attIn");
  const attOut = document.getElementById("attOut");
  const attExcuse = document.getElementById("attExcuse");
  const attOutFactory = document.getElementById("attOutFactory");
  const attNote = document.getElementById("attNote");

  [attDate, attEmp, attIn, attOut, attExcuse].forEach(el=> el.addEventListener("input", updateAttendanceCalcPreview));
  attEmp.addEventListener("change", loadAttendanceForm);
  attDate.addEventListener("change", loadAttendanceForm);

  document.getElementById("saveAttBtn").onclick = ()=>{
    const empId = attEmp.value;
    const dateStr = attDate.value;
    if(!empId || !dateStr){ toast("err","Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª","Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù ÙˆØªØ§Ø±ÙŠØ®."); return; }

    const emp = db.employees.find(e=>e.id===empId);
    if(!emp){ toast("err","Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯",""); return; }

    const excuseType = attExcuse.value;
    const checkIn = attIn.value || "";
    const checkOut = attOut.value || "";
    const outOfFactory = (attOutFactory.value === "true");
    const note = attNote.value.trim();

    const derived = computeDerived(db, dateStr, empId, checkIn, checkOut, excuseType);
    if(derived.warn) toast("err","ØªÙ†Ø¨ÙŠÙ‡", derived.warn);

    const rec = {
      date: dateStr,
      employeeId: empId,
      checkIn: excuseType==="absent_excused" ? "" : checkIn,
      checkOut: excuseType==="absent_excused" ? "" : checkOut,
      overtimeMinutes: derived.overtimeMinutes||0,
      lateMinutes: derived.lateMinutes||0,
      earlyLeaveMinutes: derived.earlyLeaveMinutes||0,
      excuseType,
      outOfFactory,
      note
    };

    setAttendanceRecord(db, dateStr, empId, rec);
    saveDB(db);
    toast("ok","ØªÙ…","ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙˆØ§Ù….");
    renderAttendanceDay();
    renderPayroll();
    updateStats();
  };

  document.getElementById("delAttBtn").onclick = ()=>{
    const empId = attEmp.value;
    const dateStr = attDate.value;
    if(!empId || !dateStr){ toast("err","Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù ÙˆØªØ§Ø±ÙŠØ®",""); return; }
    if(!confirm("Ø­Ø°Ù Ø³Ø¬Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ù…ÙˆØ¸ÙØŸ")) return;
    deleteAttendanceRecord(db, dateStr, empId);
    saveDB(db);
    toast("ok","ØªÙ…","ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„.");
    loadAttendanceForm();
    renderAttendanceDay();
    renderPayroll();
    updateStats();
  };

  function renderAttendanceSelectors(){
    const emps = db.employees.filter(e=>e.active!==false).sort((a,b)=>a.name.localeCompare(b.name,'ar'));
    attEmp.innerHTML = "";
    advEmp.innerHTML = "";
    emps.forEach(e=>{
      const o1 = document.createElement("option"); o1.value=e.id; o1.textContent=e.name;
      const o2 = document.createElement("option"); o2.value=e.id; o2.textContent=e.name;
      attEmp.appendChild(o1); advEmp.appendChild(o2);
    });
    if(emps.length===0){
      const o = document.createElement("option"); o.value=""; o.textContent="â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† â€”";
      attEmp.appendChild(o);
      advEmp.appendChild(o.cloneNode(true));
    }
  }

  function loadAttendanceForm(){
    const empId = attEmp.value;
    const dateStr = attDate.value;
    const rec = empId && dateStr ? getAttendanceRecord(db, dateStr, empId) : null;
    if(rec){
      attIn.value = rec.checkIn || "";
      attOut.value = rec.checkOut || "";
      attExcuse.value = rec.excuseType || "none";
      attOutFactory.value = rec.outOfFactory ? "true":"false";
      attNote.value = rec.note || "";
    }else{
      attIn.value = "";
      attOut.value = "";
      attExcuse.value = "none";
      attOutFactory.value = "false";
      attNote.value = "";
    }
    updateAttendanceCalcPreview();
  }

  function updateAttendanceCalcPreview(){
    const empId = attEmp.value;
    const dateStr = attDate.value;
    if(!empId || !dateStr){ document.getElementById("attCalcTxt").textContent = "â€”"; return; }
    const d = computeDerived(db, dateStr, empId, attIn.value, attOut.value, attExcuse.value);
    let txt = `ØªØ£Ø®ÙŠØ±: ${minutesToHM(d.lateMinutes)} â€” Ù…Ø¨ÙƒØ±: ${minutesToHM(d.earlyLeaveMinutes)} â€” Ø¥Ø¶Ø§ÙÙŠ: ${minutesToHM(d.overtimeMinutes)}`;
    if(d.warn) txt += ` â€” (${d.warn})`;
    document.getElementById("attCalcTxt").textContent = txt;
  }

  attListDate.addEventListener("change", renderAttendanceDay);
  attListSearch.addEventListener("input", renderAttendanceDay);

  function renderAttendanceDay(){
    const dateStr = attListDate.value;
    const q = attListSearch.value.trim();
    const tbody = document.getElementById("attTbody");
    tbody.innerHTML = "";

    const map = db.attendance?.[dateStr] || {};
    const rows = Object.values(map);
    const empsById = Object.fromEntries(db.employees.map(e=>[e.id,e]));
    rows
      .filter(r=>{
        const nm = empsById[r.employeeId]?.name || "";
        return !q || nm.includes(q);
      })
      .sort((a,b)=> (empsById[a.employeeId]?.name||"").localeCompare((empsById[b.employeeId]?.name||""),'ar'))
      .forEach(r=>{
        const nm = empsById[r.employeeId]?.name || "â€”";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(nm)}</td>
          <td>${escapeHtml(r.checkIn||"")}</td>
          <td>${escapeHtml(r.checkOut||"")}</td>
          <td>${escapeHtml(minutesToHM(r.overtimeMinutes||0))}</td>
          <td>${escapeHtml(minutesToHM(r.lateMinutes||0))}</td>
          <td>${escapeHtml(minutesToHM(r.earlyLeaveMinutes||0))}</td>
          <td>${escapeHtml(r.excuseType||"none")}</td>
          <td>${r.outOfFactory ? "Ù†Ø¹Ù…":"Ù„Ø§"}</td>
          <td>${escapeHtml(r.note||"")}</td>
          <td><button class="btn small" data-open>ÙØªØ­</button></td>
        `;
        tr.querySelector("[data-open]").onclick = ()=>{
          attDate.value = r.date;
          attEmp.value = r.employeeId;
          loadAttendanceForm();
          toast("ok","ØªÙ…","ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.");
          window.scrollTo({top:0,behavior:"smooth"});
        };
        tbody.appendChild(tr);
      });

    if(rows.length===0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="10" style="text-align:center;color:rgba(168,179,214,.9)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</td>`;
      tbody.appendChild(tr);
    }
  }

  // Advances
  const advYm = document.getElementById("advYm");
  advYm.addEventListener("change", loadAdvanceForm);
  advEmp.addEventListener("change", loadAdvanceForm);

  document.getElementById("saveAdvBtn").onclick = ()=>{
    const ym = advYm.value;
    const empId = advEmp.value;
    if(!ym || !empId){ toast("err","Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",""); return; }
    setAdvance(db, ym, empId, {amount:document.getElementById("advAmount").value, note:document.getElementById("advNote").value});
    saveDB(db);
    toast("ok","ØªÙ…","ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù„ÙØ©.");
    renderPayroll();
  };

  function loadAdvanceForm(){
    const ym = advYm.value;
    const empId = advEmp.value;
    const adv = (ym && empId) ? getAdvance(db, ym, empId) : {amount:0,note:""};
    document.getElementById("advAmount").value = adv.amount||0;
    document.getElementById("advNote").value = adv.note||"";
  }

  // Payroll
  document.getElementById("payYm").addEventListener("change", renderPayroll);
  document.getElementById("paySearch").addEventListener("input", renderPayroll);

  document.getElementById("exportPayrollBtn").onclick = ()=>{
    const ym = document.getElementById("payYm").value;
    if(!ym){ toast("err","Ø§Ø®ØªØ± Ø´Ù‡Ø±",""); return; }
    const rows = buildPayrollRows(ym, "");
    const header = ["Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù","Ø§Ù„Ù‚Ø³Ù…","Ø§Ù„Ø±Ø§ØªØ¨","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ (Ø³Ø§Ø¹Ø§Øª)","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ£Ø®ÙŠØ± (Ø³Ø§Ø¹Ø§Øª)","Ø®ØµÙ… Ø§Ù„ØªØ£Ø®ÙŠØ±","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ± (Ø³Ø§Ø¹Ø§Øª)","Ø®ØµÙ… Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ±","Ø§Ù„Ø³Ù„Ù","Ø§Ù„Ù…Ø³ØªØ­Ù‚"];
    downloadCSV(`payroll_${ym}.csv`, [header, ...rows.map(r=>r.csv)]);
    toast("ok","ØªÙ…","ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±.");
  };

  function buildPayrollRows(ym, q){
    const depById = Object.fromEntries(db.departments.map(d=>[d.id,d.name]));
    const emps = db.employees.filter(e=>e.active!==false).filter(e=>!q || e.name.includes(q));
    return emps.sort((a,b)=>a.name.localeCompare(b.name,'ar')).map(emp=>{
      const pay = calcPayrollForEmployee(db, ym, emp);
      const lateH = pay.totalLateMin/60;
      const earlyH = pay.totalEarlyMin/60;
      const otH = pay.totalOtMin/60;
      const dep = depById[emp.departmentId] || "â€”";
      return {
        emp, pay, dep,
        csv: [
          emp.name,
          dep,
          emp.monthlySalary,
          otH.toFixed(2),
          pay.otValue.toFixed(2),
          lateH.toFixed(2),
          pay.lateDeduction.toFixed(2),
          earlyH.toFixed(2),
          pay.earlyDeduction.toFixed(2),
          pay.advances.toFixed(2),
          pay.net.toFixed(2)
        ]
      };
    });
  }

  function renderPayroll(){
    const ym = document.getElementById("payYm").value;
    const q = document.getElementById("paySearch").value.trim();
    const tbody = document.getElementById("payTbody");
    tbody.innerHTML = "";

    if(!ym){
      tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;color:rgba(168,179,214,.9)">Ø§Ø®ØªØ± Ø´Ù‡Ø±</td></tr>`;
      return;
    }

    const rows = buildPayrollRows(ym, q);
    if(rows.length===0){
      tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;color:rgba(168,179,214,.9)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
      return;
    }

    rows.forEach(({emp, pay, dep})=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(emp.name)}</td>
        <td>${escapeHtml(dep)}</td>
        <td>${fmtMoney(emp.monthlySalary)}</td>
        <td>${(pay.totalOtMin/60).toFixed(2)}</td>
        <td>${fmtMoney(pay.otValue)}</td>
        <td>${(pay.totalLateMin/60).toFixed(2)}</td>
        <td>${fmtMoney(pay.lateDeduction)}</td>
        <td>${(pay.totalEarlyMin/60).toFixed(2)}</td>
        <td>${fmtMoney(pay.earlyDeduction)}</td>
        <td>${fmtMoney(pay.advances)}</td>
        <td><b>${fmtMoney(pay.net)}</b></td>
        <td>
          <button class="btn small primary" data-slip>ØµÙƒ Ù‚Ø¨Ø¶</button>
        </td>
      `;
      tr.querySelector("[data-slip]").onclick = ()=> openPayslipPrintWindow(db, ym, emp);
      tbody.appendChild(tr);
    });
  }

  // Templates + Backup
  document.getElementById("tplEmployeesBtn").onclick = ()=>{
    downloadCSV("employees_template.csv", [["Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù‚Ø³Ù…","Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ","Ù…Ù„Ø§Ø­Ø¸Ø©"]]);
  };
  document.getElementById("tplAttendanceBtn").onclick = ()=>{
    downloadCSV("attendance_template.csv", [["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù","Ø§Ù„Ø¯Ø®ÙˆÙ„","Ø§Ù„Ø®Ø±ÙˆØ¬","Ø¹Ø°Ø±","Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø°Ø±","Ù…Ø´ÙˆØ§Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙ†Ø¹","Ù…Ù„Ø§Ø­Ø¸Ø©"]]);
  };

  document.getElementById("backupBtn").onclick = ()=>{
    const blob = JSON.stringify(db, null, 2);
    downloadText(`backup_${nowISODate()}.json`, blob);
    toast("ok","ØªÙ…","ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.");
  };

  document.getElementById("impBackup").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const obj = JSON.parse(txt);
      if(!obj || typeof obj !== "object") throw new Error("invalid");
      localStorage.setItem(APP_KEY, JSON.stringify(obj));
      toast("ok","ØªÙ…","ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø©. Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");
      setTimeout(()=>location.reload(), 800);
    }catch(err){
      console.error(err);
      toast("err","ÙØ´Ù„","Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­.");
    }
  });

  document.getElementById("impEmployees").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const rows = parseCSV(txt).filter(r=>r.some(x=>String(x).trim()!==""));
      if(rows.length<2){ toast("err","Ù…Ù„Ù ÙØ§Ø±Øº",""); return; }
      const header = rows[0].map(h=>h.trim());
      const idxName = header.indexOf("Ø§Ù„Ø§Ø³Ù…");
      const idxDep = header.indexOf("Ø§Ù„Ù‚Ø³Ù…");
      const idxSal = header.indexOf("Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ");
      const idxNote = header.indexOf("Ù…Ù„Ø§Ø­Ø¸Ø©");
      if(idxName<0 || idxDep<0 || idxSal<0){
        toast("err","Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.");
        return;
      }

      rows.slice(1).forEach(r=>{
        const name = (r[idxName]||"").trim();
        const depName = (r[idxDep]||"").trim();
        const sal = Number((r[idxSal]||"0").toString().replace(/[^\d.]/g,"")) || 0;
        const note = idxNote>=0 ? (r[idxNote]||"").trim() : "";
        if(!name || !depName || sal<=0) return;

        let dep = db.departments.find(d=>d.name===depName);
        if(!dep){
          dep = {id:uid("dep"), name:depName};
          db.departments.push(dep);
        }

        let emp = db.employees.find(e=>e.name===name);
        if(!emp){
          emp = {id:uid("emp"), name, departmentId:dep.id, monthlySalary:sal, active:true, notes:note};
          db.employees.push(emp);
        }else{
          emp.departmentId = dep.id;
          emp.monthlySalary = sal;
          emp.notes = note;
          emp.active = true;
        }
      });

      saveDB(db);
      renderDeps(); renderEmpDepOptions(); renderEmployees(); renderAttendanceSelectors(); renderPayroll();
      updateStats();
      toast("ok","ØªÙ…","ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.");
    }catch(err){
      console.error(err);
      toast("err","ÙØ´Ù„","ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù CSV.");
    }
  });

  document.getElementById("impAttendance").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const rows = parseCSV(txt).filter(r=>r.some(x=>String(x).trim()!==""));
      if(rows.length<2){ toast("err","Ù…Ù„Ù ÙØ§Ø±Øº",""); return; }
      const header = rows[0].map(h=>h.trim());

      const idxDate = header.indexOf("Ø§Ù„ØªØ§Ø±ÙŠØ®");
      const idxEmp = header.indexOf("Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù");
      const idxIn = header.indexOf("Ø§Ù„Ø¯Ø®ÙˆÙ„");
      const idxOut = header.indexOf("Ø§Ù„Ø®Ø±ÙˆØ¬");
      const idxExc = header.indexOf("Ø¹Ø°Ø±");
      const idxExcType = header.indexOf("Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø°Ø±");
      const idxOutFac = header.indexOf("Ù…Ø´ÙˆØ§Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙ†Ø¹");
      const idxNote = header.indexOf("Ù…Ù„Ø§Ø­Ø¸Ø©");

      if(idxDate<0 || idxEmp<0){
        toast("err","Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©","Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ§Ù….");
        return;
      }

      rows.slice(1).forEach(r=>{
        const dateStr = (r[idxDate]||"").trim();
        const empName = (r[idxEmp]||"").trim();
        if(!dateStr || !empName) return;
        const emp = db.employees.find(e=>e.name===empName);
        if(!emp) return;

        const checkIn = idxIn>=0 ? (r[idxIn]||"").trim() : "";
        const checkOut = idxOut>=0 ? (r[idxOut]||"").trim() : "";
        const excYes = idxExc>=0 ? (r[idxExc]||"").trim() : "";
        const excTypeRaw = idxExcType>=0 ? (r[idxExcType]||"").trim() : "";
        let excuseType = "none";
        if(excYes==="Ù†Ø¹Ù…" || excYes==="yes" || excYes==="true"){
          if(excTypeRaw.includes("ØªØ£Ø®ÙŠØ±")) excuseType = "late_excused";
          else if(excTypeRaw.includes("Ø§Ù†ØµØ±Ø§Ù")) excuseType = "early_excused";
          else if(excTypeRaw.includes("ØºÙŠØ§Ø¨")) excuseType = "absent_excused";
          else excuseType = "late_excused";
        }
        const outOfFactory = idxOutFac>=0 ? ((r[idxOutFac]||"").trim()==="Ù†Ø¹Ù…") : false;
        const note = idxNote>=0 ? (r[idxNote]||"").trim() : "";

        const derived = computeDerived(db, dateStr, emp.id, checkIn, checkOut, excuseType);
        const rec = {
          date: dateStr,
          employeeId: emp.id,
          checkIn: excuseType==="absent_excused" ? "" : checkIn,
          checkOut: excuseType==="absent_excused" ? "" : checkOut,
          overtimeMinutes: derived.overtimeMinutes||0,
          lateMinutes: derived.lateMinutes||0,
          earlyLeaveMinutes: derived.earlyLeaveMinutes||0,
          excuseType,
          outOfFactory,
          note
        };
        setAttendanceRecord(db, dateStr, emp.id, rec);
      });

      saveDB(db);
      renderAttendanceDay(); renderPayroll(); updateStats();
      toast("ok","ØªÙ…","ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ§Ù… (Ø¨Ø§Ù„Ù‚Ø¯Ø± Ø§Ù„Ù…ØªÙˆÙØ±).");
    }catch(err){
      console.error(err);
      toast("err","ÙØ´Ù„","ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù CSV.");
    }
  });

  // Init
  renderDeps();
  renderEmpDepOptions();
  renderEmployees();
  renderManagers();
  renderAttendanceSelectors();
  loadAttendanceForm();
  renderAttendanceDay();
  loadAdvanceForm();
  loadMonthForm();
  renderPayroll();

})();
</script>
</body>
</html>
