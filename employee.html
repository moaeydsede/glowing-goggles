<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>بوابة الموظف</title>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

<style>
/* إضافات بسيطة فوق Tailwind */
html, body { height: 100%; }
body { background: #f6f7fb; }
.card { border-radius: 18px; box-shadow: 0 10px 30px rgba(16,24,40,.08); }
.btn { border-radius: 14px; }

</style>
</head>
<body class="min-h-screen">
<div id="toast" style="display:none"></div>
<div class="max-w-3xl mx-auto px-3 sm:px-6 py-4">
  <div class="bg-white card p-4 sm:p-6">
    <div id="topbar"></div>
    <div class="mt-4 flex items-center justify-between gap-2 flex-wrap">
      <div class="text-sm text-slate-600">يمكنك مشاهدة الشهر الحالي وشهر واحد سابق فقط.</div>
      <select id="monthSel" class="border border-slate-200 rounded-2xl px-3 py-2 bg-white text-sm"></select>
    </div>
  </div>

  <div id="empView" class="mt-4"></div>
</div>


<script>

(function(){
  function banner(msg){
    try{
      var box=document.getElementById("errBanner");
      if(!box){
        box=document.createElement("div");
        box.id="errBanner";
        box.style.position="fixed";
        box.style.left="12px";
        box.style.right="12px";
        box.style.top="12px";
        box.style.zIndex="99999";
        box.style.background="#b91c1c";
        box.style.color="#fff";
        box.style.padding="10px 12px";
        box.style.borderRadius="14px";
        box.style.boxShadow="0 12px 30px rgba(0,0,0,.18)";
        box.style.fontSize="12px";
        box.style.lineHeight="1.6";
        document.body.appendChild(box);
      }
      box.textContent = msg;
    }catch(e){}
  }
  window.addEventListener("error", function(ev){
    // تجاهل أخطاء تحميل الموارد (Script/CSS) لأنها لا تمنع الدخول غالباً
    try{
      if(ev && ev.target && (ev.target.tagName==="SCRIPT" || ev.target.tagName==="LINK")) return;
    }catch(e){}
    banner("حدث خطأ داخل الصفحة. جرّب تحديث الصفحة. إن استمر، أخبرنا بنوع جهازك والمتصفح.");
    try{ console.error(ev.error||ev.message); }catch(e){}
  });
})();

\
const LS_KEY = "HR_SYS_V1";

// ===== Storage Safe Wrapper (لمنع توقف النظام إذا كان التخزين محجوبًا) =====
const __memStore = { local: {}, session: {} };

function _safeGet(storage, key){
  try { return storage.getItem(key); } catch(e){ return __memStore[storage===localStorage?"local":"session"][key] ?? null; }
}
function _safeSet(storage, key, val){
  try { storage.setItem(key, val); } catch(e){ __memStore[storage===localStorage?"local":"session"][key] = val; }
}
function _safeRemove(storage, key){
  try { storage.removeItem(key); } catch(e){ delete __memStore[storage===localStorage?"local":"session"][key]; }
}

// Error overlay للموبايل
function showFatalError(msg){
  try{
    let box = document.getElementById("fatalError");
    if(!box){
      box = document.createElement("div");
      box.id="fatalError";
      box.style.position="fixed";
      box.style.left="12px";
      box.style.right="12px";
      box.style.bottom="12px";
      box.style.zIndex="99999";
      box.style.background="#b91c1c";
      box.style.color="#fff";
      box.style.padding="14px 14px";
      box.style.borderRadius="16px";
      box.style.boxShadow="0 12px 30px rgba(0,0,0,.18)";
      box.style.fontSize="13px";
      box.style.lineHeight="1.6";
      document.body.appendChild(box);
    }
    box.textContent = msg;
  }catch(e){}
}

window.addEventListener("error", (ev)=>{
  try{ console.error(ev.error || ev.message); }catch(e){}
  showFatalError("حدث خطأ منع تشغيل الصفحة. جرّب تحديث الصفحة. إن استمر، افتح من Chrome. ");
});
window.addEventListener("unhandledrejection", (ev)=>{
  try{ console.error(ev.reason); }catch(e){}
  showFatalError("حدث خطأ داخلي. جرّب تحديث الصفحة. ");
});

function uuid(){
  // دعم للمتصفحات التي لا تدعم uuid()
  try{
    if (crypto && typeof crypto.randomUUID === "function") return uuid();
    if (crypto && crypto.getRandomValues){
      const b = new Uint8Array(16);
      crypto.getRandomValues(b);
      // RFC4122 v4
      b[6] = (b[6] & 0x0f) | 0x40;
      b[8] = (b[8] & 0x3f) | 0x80;
      const h = [...b].map(x=>x.toString(16).padStart(2,"0")).join("");
      return `${h.slice(0,8)}-${h.slice(8,12)}-${h.slice(12,16)}-${h.slice(16,20)}-${h.slice(20)}`;
    }
  }catch(e){}
  // fallback ضعيف لكن يعمل
  return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
}

window.addEventListener("error", (ev)=>{
  try{ console.error(ev.error || ev.message); }catch(e){}
});

function nowDateISO() {
  const d = new Date();
  return d.toISOString().slice(0,10);
}
function pad2(n){ return String(n).padStart(2,"0"); }
function ymKey(year, month){ return `${year}-${pad2(month)}`; }
function parseTimeToMinutes(hhmm){
  if(!hhmm) return null;
  const [h,m]=hhmm.split(":").map(Number);
  if(Number.isNaN(h)||Number.isNaN(m)) return null;
  return h*60+m;
}
function minutesToTime(min){
  if(min==null) return "-";
  const h=Math.floor(min/60), m=Math.abs(min%60);
  return `${pad2(h)}:${pad2(m)}`;
}
function dayNameAr(dateISO){
  const d=new Date(dateISO+"T00:00:00");
  const names=["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
  return names[d.getDay()];
}
function monthNameAr(m){
  const names=["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
  return names[m-1]||"";
}
function safeJSONParse(s, fallback){
  try{ return JSON.parse(s); }catch(e){ return fallback; }
}

function defaultState(){
  const d=new Date();
  const y=d.getFullYear(), m=d.getMonth()+1;
  return {
    company: { name: "اسم الشركة", logoDataUrl: "" },
    auth: {
      admin: { username: "admin", password: "admin123" },
      managers: [] // {username,password,name}
    },
    departments: [
      { id: uuid(), name: "إدارة" },
      { id: uuid(), name: "مبيعات" },
      { id: uuid(), name: "مخزن" },
      { id: uuid(), name: "إنتاج" }
    ],
    employees: [
      { id: uuid(), name: "محمد", code: "E001", departmentId: null, monthlySalary: 6000, active: true },
      { id: uuid(), name: "أحمد", code: "E002", departmentId: null, monthlySalary: 5500, active: true }
    ],
    settingsByMonth: {
      [ymKey(y,m)]: {
        year:y, month:m,
        daysInMonth: new Date(y,m,0).getDate(),
        hoursInMonth: 208,
        shiftStart: "10:00",
        shiftEnd: "17:00",
        lateGraceMin: 0,
        lateMultiplier: 1.5,
        earlyGraceMin: 0,
        earlyMultiplier: 1.0,
        overtimeStartAfterMin: 0,
        overtimeMultiplier: 1.5,
        rounding: "MINUTE" // MINUTE|5|15
      }
    },
    advancesByMonth: {
      // ym: { employeeId: amount }
    },
    attendanceByMonth: {
      // ym: { employeeId: { dateISO: {in:"HH:mm", out:"HH:mm", excuseAbsence:false, excuseLate:false, excuseEarly:false, note:"", extraOvertimeMin:null} } }
    },
    audit: []
  };
}

function loadState(){
  const s = _safeGet(localStorage, LS_KEY);
  if(!s){
    const st = defaultState();
    saveState(st);
    return st;
  }
  const st = safeJSONParse(s, defaultState());
  // ensure minimal fields
  if(!st.company) st.company = { name:"اسم الشركة", logoDataUrl:"" };
  if(!st.auth?.admin) st.auth = { admin:{username:"admin",password:"admin123"}, managers:[] };
  if(!st.departments) st.departments = [];
  if(!st.employees) st.employees = [];
  if(!st.settingsByMonth) st.settingsByMonth = {};
  if(!st.attendanceByMonth) st.attendanceByMonth = {};
  if(!st.advancesByMonth) st.advancesByMonth = {};
  if(!st.audit) st.audit = [];
  return st;
}

function saveState(st){
  _safeSet(localStorage, LS_KEY, JSON.stringify(st));
}

function addAudit(st, action, payload){
  st.audit.unshift({ id: uuid(), at: new Date().toISOString(), action, payload });
  st.audit = st.audit.slice(0, 500);
}

function requireRole(role){
  const s = _safeGet(sessionStorage, "HR_SESSION");
  if(!s) location.href = "./index.html";
  const sess = safeJSONParse(s, null);
  if(!sess || sess.role !== role) location.href = "./index.html";
  return sess;
}

function setSession(sess){
  _safeSet(sessionStorage, "HR_SESSION", JSON.stringify(sess));
}

function clearSession(){
  _safeRemove(sessionStorage, "HR_SESSION");
}

function toast(msg, ok=true){
  const el = document.getElementById("toast");
  if(!el) { alert(msg); return; }
  el.textContent = msg;
  el.className = `fixed top-4 right-4 z-50 px-4 py-3 text-sm rounded-2xl shadow-lg ${ok ? "bg-emerald-600 text-white" : "bg-rose-600 text-white"}`;
  el.style.display = "block";
  setTimeout(()=>{ el.style.display="none"; }, 2200);
}

function downloadFile(filename, blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function roundMinutes(min, rule){
  if(min==null) return 0;
  if(!rule || rule==="MINUTE") return min;
  const step = Number(rule);
  if(!step || step<=1) return min;
  return Math.round(min/step)*step;
}

function computeDaySummary({dateISO, rec, cfg}){
  // rec: {in,out,excuseAbsence,excuseLate,excuseEarly,extraOvertimeMin}
  const startMin = parseTimeToMinutes(cfg.shiftStart);
  const endMin = parseTimeToMinutes(cfg.shiftEnd);

  const inMin = parseTimeToMinutes(rec?.in);
  const outMin = parseTimeToMinutes(rec?.out);

  let status = "PRESENT";
  if(!inMin && !outMin) status = "ABSENT";

  if(rec?.excuseAbsence) status = "EXCUSED_ABSENT";

  let late=0, early=0, overtime=0;

  if(status==="PRESENT" && inMin!=null){
    late = Math.max(0, inMin - (startMin + (cfg.lateGraceMin||0)));
  }
  if(status==="PRESENT" && outMin!=null){
    early = Math.max(0, (endMin - (cfg.earlyGraceMin||0)) - outMin);
    const otStart = endMin + (cfg.overtimeStartAfterMin||0);
    overtime = Math.max(0, outMin - otStart);
  }

  if(rec?.excuseLate) late = 0;
  if(rec?.excuseEarly) early = 0;
  if(rec?.extraOvertimeMin!=null && rec.extraOvertimeMin!=="" && !Number.isNaN(Number(rec.extraOvertimeMin))){
    overtime = Number(rec.extraOvertimeMin);
  }

  late = roundMinutes(late, cfg.rounding);
  early = roundMinutes(early, cfg.rounding);
  overtime = roundMinutes(overtime, cfg.rounding);

  return { status, inMin, outMin, lateMin:late, earlyMin:early, overtimeMin:overtime };
}

function computePayroll({employee, cfg, monthAttendance, advancesAmount}){
  const hourly = employee.monthlySalary / cfg.hoursInMonth;
  let late=0, early=0, ot=0;
  for(const dateISO of Object.keys(monthAttendance||{})){
    const rec = monthAttendance[dateISO];
    const s = computeDaySummary({dateISO, rec, cfg});
    late += s.lateMin||0;
    early += s.earlyMin||0;
    ot += s.overtimeMin||0;
  }
  const lateDed = (late/60) * hourly * (cfg.lateMultiplier||1.5);
  const earlyDed = (early/60) * hourly * (cfg.earlyMultiplier||1.0);
  const otPay = (ot/60) * hourly * (cfg.overtimeMultiplier||1.5);
  const net = employee.monthlySalary + otPay - lateDed - earlyDed - (advancesAmount||0);

  return {
    hourlyRate: hourly,
    totals: { lateMin: late, earlyMin: early, overtimeMin: ot },
    amounts: { lateDeduction: lateDed, earlyDeduction: earlyDed, overtimePay: otPay, advances: advancesAmount||0, net }
  };
}

\
function renderTopbar({title, subtitle, role}){
  const company = loadState().company;
  const logo = company.logoDataUrl ? `<img src="${company.logoDataUrl}" class="h-9 w-9 rounded-2xl object-cover ring-1 ring-slate-200" />` :
    `<div class="h-9 w-9 rounded-2xl bg-slate-100 ring-1 ring-slate-200 grid place-items-center text-slate-500 text-xs">LOGO</div>`;
  return `
  <div class="flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      ${logo}
      <div>
        <div class="text-sm text-slate-500">${company.name || "اسم الشركة"}</div>
        <div class="text-xl font-bold text-slate-900">${title}</div>
        ${subtitle ? `<div class="text-sm text-slate-500 mt-1">${subtitle}</div>` : ``}
      </div>
    </div>
    <div class="flex items-center gap-2">
      <span class="px-3 py-1.5 rounded-2xl bg-slate-100 text-slate-700 text-sm">${role}</span>
      <button onclick="logout()" class="px-3 py-2 rounded-2xl bg-slate-900 text-white text-sm">خروج</button>
    </div>
  </div>
  `;
}

function logout(){
  clearSession();
  location.href = "./index.html";
}

\
(function(){
  const sess = requireRole("EMPLOYEE");
  const st = loadState();
  const emp = st.employees.find(e=>e.id===sess.employeeId);
  if(!emp){
    toast("تم حذف الموظف من النظام", false);
    logout();
    return;
  }

  document.getElementById("topbar").innerHTML = renderTopbar({
    title: "بوابة الموظف",
    subtitle: `مرحبًا ${emp.name} — عرض فقط`,
    role: "Employee"
  });

  const monthSel = document.getElementById("monthSel");
  const empView = document.getElementById("empView");

  function allowedMonths(){
    const d = new Date();
    const now = ymKey(d.getFullYear(), d.getMonth()+1);
    const prevD = new Date(d.getFullYear(), d.getMonth()-1, 1);
    const prev = ymKey(prevD.getFullYear(), prevD.getMonth()+1);
    return [now, prev];
  }

  function render(){
    const st2 = loadState(); // auto refresh from storage (same device)
    const allowed = allowedMonths();
    monthSel.innerHTML = allowed.map(ym=>{
      const [y,m] = ym.split("-").map(Number);
      return `<option value="${ym}">${y}-${pad2(m)} (${monthNameAr(m)})</option>`;
    }).join("");

    const selected = sessionStorage.getItem("EMP_MONTH") || allowed[0];
    monthSel.value = allowed.includes(selected) ? selected : allowed[0];

    const ym = monthSel.value;
    const cfg = st2.settingsByMonth[ym];
    const att = (st2.attendanceByMonth[ym]||{})[emp.id] || {};
    const adv = (st2.advancesByMonth[ym]||{})[emp.id] || 0;

    if(!cfg){
      empView.innerHTML = `
      <div class="bg-white card p-5">
        <div class="text-lg font-bold">لا توجد بيانات لهذا الشهر</div>
        <div class="text-sm text-slate-500 mt-2">اطلب من الإدارة عمل (مزامنة) لهذا الشهر.</div>
        <div class="mt-4 p-4 rounded-2xl bg-slate-50 ring-1 ring-slate-200">
          <div class="font-bold">استيراد ملف مزامنة</div>
          <input id="syncFile" type="file" accept=".json" class="mt-2 w-full border border-slate-200 rounded-2xl px-3 py-3 bg-white"/>
          <button id="importSync" class="mt-2 w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white font-semibold">استيراد</button>
        </div>
      </div>`;
      document.getElementById("importSync").onclick = async ()=>{
        const f = document.getElementById("syncFile").files[0];
        if(!f) return toast("اختر ملف مزامنة", false);
        const payload = safeJSONParse(await f.text(), null);
        if(!payload || payload.v!==1) return toast("ملف غير صالح", false);
        const st3 = loadState();
        st3.company = payload.company || st3.company;
        st3.departments = payload.departments || st3.departments;
        st3.employees = (payload.employees||[]).map(e=>({ ...e, active:true }));
        st3.settingsByMonth = { ...st3.settingsByMonth, ...(payload.settingsByMonth||{}) };
        st3.attendanceByMonth = { ...st3.attendanceByMonth, ...(payload.attendanceByMonth||{}) };
        st3.advancesByMonth = { ...st3.advancesByMonth, ...(payload.advancesByMonth||{}) };
        saveState(st3);
        toast("تم استيراد المزامنة");
        location.reload();
      };
      return;
    }

    // compute
    const pay = computePayroll({ employee: emp, cfg, monthAttendance: att, advancesAmount: adv });

    // build cards per day
    const cards = [];
    for(let day=1; day<=cfg.daysInMonth; day++){
      const dateISO = `${cfg.year}-${pad2(cfg.month)}-${pad2(day)}`;
      const rec = att[dateISO] || {};
      const s = computeDaySummary({ dateISO, rec, cfg });
      cards.push(`
        <div class="p-4 rounded-2xl bg-white ring-1 ring-slate-200">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-bold">${dateISO}</div>
              <div class="text-xs text-slate-500 mt-1">${dayNameAr(dateISO)}</div>
            </div>
            <span class="px-3 py-1.5 rounded-2xl text-xs ${s.status==="EXCUSED_ABSENT"?"bg-amber-100 text-amber-700":(s.status==="ABSENT"?"bg-rose-100 text-rose-700":"bg-emerald-100 text-emerald-700")}">
              ${s.status==="EXCUSED_ABSENT"?"غياب بعذر":(s.status==="ABSENT"?"غياب":"حضور")}
            </span>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
            <div class="p-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200">
              <div class="text-xs text-slate-500">الدخول</div>
              <div class="font-bold mt-1">${rec.in || "-"}</div>
            </div>
            <div class="p-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200">
              <div class="text-xs text-slate-500">الخروج</div>
              <div class="font-bold mt-1">${rec.out || "-"}</div>
            </div>
            <div class="p-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200">
              <div class="text-xs text-slate-500">الإضافي</div>
              <div class="font-bold mt-1">${(s.overtimeMin/60).toFixed(2)} س</div>
            </div>
            <div class="p-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200">
              <div class="text-xs text-slate-500">التأخير</div>
              <div class="font-bold mt-1">${(s.lateMin/60).toFixed(2)} س</div>
            </div>
            <div class="p-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200 col-span-2">
              <div class="text-xs text-slate-500">الانصراف المبكر</div>
              <div class="font-bold mt-1">${(s.earlyMin/60).toFixed(2)} س</div>
            </div>
          </div>
          ${rec.note ? `<div class="mt-3 text-xs text-slate-500">ملاحظة: ${rec.note}</div>` : ``}
        </div>
      `);
    }

    empView.innerHTML = `
      <div class="bg-white card p-5">
        <div class="flex items-center justify-between flex-wrap gap-2">
          <div>
            <div class="text-lg font-bold">الشهر: ${cfg.year}-${pad2(cfg.month)} (${monthNameAr(cfg.month)})</div>
            <div class="text-sm text-slate-500 mt-1">الدوام: ${cfg.shiftStart} → ${cfg.shiftEnd}</div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button id="btnPDF" class="px-4 py-3 rounded-2xl bg-emerald-600 text-white font-semibold">تحميل صك قبض PDF</button>
            <button id="btnImportSync" class="px-4 py-3 rounded-2xl bg-slate-900 text-white font-semibold">تحديث من ملف مزامنة</button>
          </div>
        </div>

        <div class="mt-4 grid gap-2 sm:grid-cols-4 text-sm">
          <div class="p-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200">
            <div class="text-xs text-slate-500">قيمة الساعة</div>
            <div class="font-bold mt-1">${pay.hourlyRate.toFixed(2)}</div>
          </div>
          <div class="p-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200">
            <div class="text-xs text-slate-500">الإضافي</div>
            <div class="font-bold mt-1">${(pay.totals.overtimeMin/60).toFixed(2)} س — ${pay.amounts.overtimePay.toFixed(2)}</div>
          </div>
          <div class="p-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200">
            <div class="text-xs text-slate-500">التأخير</div>
            <div class="font-bold mt-1">${(pay.totals.lateMin/60).toFixed(2)} س — ${pay.amounts.lateDeduction.toFixed(2)}</div>
          </div>
          <div class="p-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200">
            <div class="text-xs text-slate-500">الانصراف المبكر</div>
            <div class="font-bold mt-1">${(pay.totals.earlyMin/60).toFixed(2)} س — ${pay.amounts.earlyDeduction.toFixed(2)}</div>
          </div>
          <div class="p-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200">
            <div class="text-xs text-slate-500">السلف</div>
            <div class="font-bold mt-1">${pay.amounts.advances.toFixed(2)}</div>
          </div>
          <div class="p-3 rounded-2xl bg-slate-50 ring-1 ring-slate-200 sm:col-span-3">
            <div class="text-xs text-slate-500">المستحق (الصافي)</div>
            <div class="text-xl font-extrabold mt-1">${pay.amounts.net.toFixed(2)}</div>
          </div>
        </div>
      </div>

      <div class="mt-4 grid gap-3">
        ${cards.join("")}
      </div>

      <div class="mt-4 bg-white card p-5">
        <div class="font-bold">استيراد ملف مزامنة</div>
        <div class="text-sm text-slate-500 mt-1">لو الإدارة عدّلت الدوام، اطلب منها ملف مزامنة للشهر الحالي.</div>
        <div class="mt-3 flex gap-2 flex-wrap">
          <input id="syncFile2" type="file" accept=".json" class="border border-slate-200 rounded-2xl px-3 py-2 bg-white"/>
          <button id="importSync2" class="px-4 py-2 rounded-2xl bg-emerald-600 text-white font-semibold">استيراد</button>
        </div>
      </div>
    `;

    document.getElementById("btnImportSync").onclick = ()=>document.getElementById("syncFile2").click();

    document.getElementById("importSync2").onclick = async ()=>{
      const f = document.getElementById("syncFile2").files[0];
      if(!f) return toast("اختر ملف مزامنة", false);
      const payload = safeJSONParse(await f.text(), null);
      if(!payload || payload.v!==1) return toast("ملف غير صالح", false);
      const st3 = loadState();
      st3.company = payload.company || st3.company;
      st3.departments = payload.departments || st3.departments;
      st3.employees = (payload.employees||[]).map(e=>({ ...e, active:true }));
      st3.settingsByMonth = { ...st3.settingsByMonth, ...(payload.settingsByMonth||{}) };
      st3.attendanceByMonth = { ...st3.attendanceByMonth, ...(payload.attendanceByMonth||{}) };
      st3.advancesByMonth = { ...st3.advancesByMonth, ...(payload.advancesByMonth||{}) };
      saveState(st3);
      toast("تم التحديث");
      location.reload();
    };

    document.getElementById("btnPDF").onclick = ()=>{
      generateVoucherPDFEmployee({ emp, ym });
    };
  }

  window.generateVoucherPDFEmployee = ({emp, ym})=>{
    const st = loadState();
    const cfg = st.settingsByMonth[ym];
    const monthAttendance = (st.attendanceByMonth[ym]||{})[emp.id] || {};
    const adv = (st.advancesByMonth[ym]||{})[emp.id] || 0;
    const pay = computePayroll({ employee: emp, cfg, monthAttendance, advancesAmount: adv });
    const deptName = st.departments.find(d=>d.id===emp.departmentId)?.name || "-";

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:"p", unit:"pt", format:"a4" });
    const company = st.company||{name:"اسم الشركة", logoDataUrl:""};
    const margin = 40;
    let y = 48;

    doc.setFont("helvetica","bold");
    doc.setFontSize(16);
    doc.text("صك قبض شهري + كشف حضور", 297, y, { align:"center" });
    y += 18;
    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.text(`${company.name || "اسم الشركة"}`, 297, y, { align:"center" });
    y += 22;

    if(company.logoDataUrl){
      try{ doc.addImage(company.logoDataUrl, "PNG", margin, 30, 48, 48); }catch(e){}
    }

    doc.setFontSize(10);
    doc.text(`اسم الموظف: ${emp.name}`, 555, 90, { align:"right" });
    doc.text(`القسم: ${deptName}`, 555, 106, { align:"right" });
    doc.text(`الشهر: ${cfg.year}-${pad2(cfg.month)} (${monthNameAr(cfg.month)})`, 555, 122, { align:"right" });

    const body = [];
    for(let day=1; day<=cfg.daysInMonth; day++){
      const dateISO = `${cfg.year}-${pad2(cfg.month)}-${pad2(day)}`;
      const rec = monthAttendance[dateISO] || {};
      const s = computeDaySummary({ dateISO, rec, cfg });
      body.push([dateISO, dayNameAr(dateISO), rec.in||"-", rec.out||"-", (s.overtimeMin/60).toFixed(2), (s.lateMin/60).toFixed(2), (s.earlyMin/60).toFixed(2)]);
    }

    doc.autoTable({
      head: [[ "التاريخ","اليوم","الدخول","الخروج","الإضافي (س)","التأخير (س)","الانصراف المبكر (س)" ]],
      body,
      startY: 150,
      styles: { font:"helvetica", fontSize: 9, cellPadding: 5 },
      headStyles: { fillColor: [15, 23, 42] }
    });

    y = doc.lastAutoTable.finalY + 14;
    doc.setFont("helvetica","bold"); doc.setFontSize(11);
    doc.text("المجاميع", 555, y, { align:"right" }); y+=14;
    doc.setFont("helvetica","normal"); doc.setFontSize(10);
    doc.text(`مجموع الإضافي: ${(pay.totals.overtimeMin/60).toFixed(2)} ساعة — قيمة الإضافي: ${pay.amounts.overtimePay.toFixed(2)}`, 555, y, { align:"right" }); y+=14;
    doc.text(`مجموع التأخير: ${(pay.totals.lateMin/60).toFixed(2)} ساعة — قيمة خصم التأخير: ${pay.amounts.lateDeduction.toFixed(2)}`, 555, y, { align:"right" }); y+=14;
    doc.text(`مجموع الانصراف المبكر: ${(pay.totals.earlyMin/60).toFixed(2)} ساعة — قيمة خصم الانصراف المبكر: ${pay.amounts.earlyDeduction.toFixed(2)}`, 555, y, { align:"right" }); y+=14;
    doc.text(`السلف: ${pay.amounts.advances.toFixed(2)}`, 555, y, { align:"right" }); y+=18;
    doc.setFont("helvetica","bold"); doc.setFontSize(13);
    doc.text(`المستحق (الصافي): ${pay.amounts.net.toFixed(2)}`, 555, y, { align:"right" });

    doc.save(`صك_قبض_${emp.name}_${ym}.pdf`);
  };

  // live update within same device
  monthSel.onchange = ()=>{
    sessionStorage.setItem("EMP_MONTH", monthSel.value);
    render();
  };

  render();
  // auto refresh every 10s (if same device updated)
  setInterval(()=>{ render(); }, 10000);
})();

</script>
</body>
</html>
