<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù… ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</title>
<style>
:root{
  --bg:#0b1220;
  --card:#0f1a30;
  --card2:#101f3a;
  --text:#eaf0ff;
  --muted:#a8b3d6;
  --line:rgba(255,255,255,.10);
  --green:#22c55e;
  --green2:#16a34a;
  --red:#ef4444;
  --amber:#f59e0b;
  --blue:#60a5fa;
  --shadow: 0 12px 30px rgba(0,0,0,.35);
  --radius:18px;
  --radius2:14px;
  --pad:14px;
  --font: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font);
  background: radial-gradient(1200px 600px at 80% -10%, rgba(34,197,94,.25), transparent 55%),
              radial-gradient(1000px 500px at 20% 0%, rgba(96,165,250,.20), transparent 55%),
              linear-gradient(180deg, #070b14 0%, #0b1220 60%, #070b14 100%);
  color:var(--text);
  direction:rtl;
}

a{color:inherit}
.container{max-width:1100px;margin:0 auto;padding:18px}
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid var(--line);
  box-shadow:var(--shadow);
  border-radius:var(--radius);
  padding:var(--pad);
  backdrop-filter: blur(8px);
}
.card + .card{margin-top:14px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 260px;min-width:240px}

.hdr{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:14px 16px;
  position:sticky;top:0;z-index:50;
  background: rgba(7,11,20,.65);
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--line);
}
.brand{
  display:flex;align-items:center;gap:10px;min-width:0
}
.brand .logo{
  width:40px;height:40px;border-radius:12px;overflow:hidden;
  background: rgba(255,255,255,.06);
  border:1px solid var(--line);
  display:grid;place-items:center;flex:0 0 auto
}
.brand .logo img{width:100%;height:100%;object-fit:cover}
.brand .title{display:flex;flex-direction:column;min-width:0}
.brand .title b{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.brand .title span{font-size:12px;color:var(--muted)}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 10px;border-radius:999px;border:1px solid var(--line);
  background: rgba(255,255,255,.05);
  font-size:12px;color:var(--muted)
}

.tabs{
  display:flex;gap:8px;flex-wrap:wrap;margin:14px 0 0;
  position:sticky;top:78px;z-index:40;
  padding-bottom:8px;background: rgba(7,11,20,.35);backdrop-filter: blur(10px);
}
.tab{
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
  color:var(--muted);
  padding:10px 12px;border-radius:999px;
  font-size:13px;cursor:pointer;user-select:none;
  transition: transform .08s ease, background .15s ease, color .15s ease;
}
.tab:active{transform:scale(.98)}
.tab.active{
  background: rgba(34,197,94,.18);
  border-color: rgba(34,197,94,.40);
  color:var(--text);
}
.section{display:none}
.section.active{display:block}

label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input,select,textarea{
  width:100%;
  padding:12px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(15,26,48,.60);
  color:var(--text);
  outline:none;
}
input::placeholder, textarea::placeholder{color:rgba(168,179,214,.65)}
textarea{min-height:90px;resize:vertical}

.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{
  border:1px solid transparent;
  background: rgba(255,255,255,.08);
  color:var(--text);
  padding:11px 14px;border-radius:14px;
  font-size:14px;cursor:pointer;user-select:none;
  display:inline-flex;align-items:center;gap:10px;
  transition: transform .08s ease, filter .15s ease, background .15s ease, border-color .15s ease;
}
.btn:active{transform:scale(.98)}
.btn.primary{background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(22,163,74,.85));}
.btn.primary:hover{filter:brightness(1.06)}
.btn.danger{background: rgba(239,68,68,.18);border-color: rgba(239,68,68,.35)}
.btn.ghost{background: rgba(255,255,255,.04);border-color: rgba(255,255,255,.10)}
.btn.small{padding:8px 10px;border-radius:12px;font-size:12px}

.hr{height:1px;background:var(--line);margin:14px 0}
.kpi{
  display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.04);
  border-radius:var(--radius2);
  padding:12px 12px;
}
.kpi b{font-size:14px}
.kpi span{font-size:12px;color:var(--muted)}
.kpi .v{font-size:18px;margin-top:4px}

.tableWrap{overflow:auto;border-radius:14px;border:1px solid var(--line)}
table{width:100%;border-collapse:collapse;min-width:720px;background: rgba(15,26,48,.45)}
th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;vertical-align:top}
th{position:sticky;top:0;background: rgba(7,11,20,.75);backdrop-filter: blur(8px);text-align:right;color:var(--muted);font-weight:600}
tr:hover td{background: rgba(255,255,255,.03)}

.toast{
  position:fixed;inset:auto 14px 14px 14px;z-index:999;
  display:flex;flex-direction:column;gap:8px;pointer-events:none
}
.toast .t{
  pointer-events:auto;
  padding:12px 12px;border-radius:14px;border:1px solid var(--line);
  background: rgba(7,11,20,.70);backdrop-filter: blur(10px);
  box-shadow:var(--shadow);
  display:flex;justify-content:space-between;gap:10px;align-items:flex-start
}
.toast .t.ok{border-color: rgba(34,197,94,.35)}
.toast .t.err{border-color: rgba(239,68,68,.35)}
.toast .t b{font-size:13px}
.toast .t span{font-size:12px;color:var(--muted)}
.toast .t button{
  background:transparent;border:0;color:var(--muted);cursor:pointer;font-size:16px;line-height:1
}

.footerNote{color:var(--muted);font-size:12px;line-height:1.7}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:7px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color:var(--muted);font-size:12px
}

@media (min-width:900px){
  .hdr{padding:16px 22px}
  .container{padding:22px}
  .tabs{top:82px}
}

@media print{
  body{background:#fff;color:#000}
  .noPrint{display:none !important}
  .card{box-shadow:none;border-color:#ddd;background:#fff}
  table{background:#fff}
  th{background:#f3f4f6;color:#111}
  td,th{border-bottom:1px solid #ddd}
}
</style>
</head>
<body>
  <div class="hdr noPrint">
    <div class="brand">
      <div class="logo" data-company-logo></div>
      <div class="title">
        <b data-company-name>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ù… ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</b>
        <span>Ù†Ø³Ø®Ø© ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø· â€” ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ GitHub Pages</span>
      </div>
    </div>
    <span class="badge">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
  </div>

  <div class="container">
    <div class="card">
      <div class="row">
        <div class="col">
          <div class="pill">ğŸ‘‘ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© / Ø§Ù„Ù…Ø¯ÙŠØ±</div>

          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
          <select id="roleSelect">
            <option value="admin">Admin (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)</option>
            <option value="manager">Manager (Ù…Ø¯ÙŠØ±)</option>
          </select>

          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="u" placeholder="Ù…Ø«Ø§Ù„: admin">

          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="p" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">

          <div class="btns">
            <button class="btn primary" id="loginAdminBtn">Ø¯Ø®ÙˆÙ„</button>
            <button class="btn ghost" id="resetBtn" title="Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­">ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</button>
          </div>

          <div class="footerNote" style="margin-top:10px">
            Ø¨ÙŠØ§Ù†Ø§Øª Admin Ø«Ø§Ø¨ØªØ©: <b>admin / admin123</b><br>
            Ù…Ù„Ø§Ø­Ø¸Ø©: ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ (LocalStorage).
          </div>
        </div>

        <div class="col">
          <div class="pill">ğŸ‘¤ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸Ù (Ø¹Ø±Ø¶ ÙÙ‚Ø·)</div>

          <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù (ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø³Ø¬Ù‘Ù„)</label>
          <input id="empName" list="empList" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
          <datalist id="empList"></datalist>

          <div class="btns">
            <button class="btn primary" id="loginEmpBtn">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸Ù</button>
          </div>

          <div class="hr"></div>

          <div class="footerNote">
            Ø§Ù„Ù…ÙˆØ¸Ù ÙŠØ³ØªØ·ÙŠØ¹ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ + Ø´Ù‡Ø± Ø³Ø§Ø¨Ù‚ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·ØŒ ÙˆØ·Ø¨Ø§Ø¹Ø© ØµÙƒ Ø§Ù„Ù‚Ø¨Ø¶ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡.
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <div class="kpi">
            <div>
              <b>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</b>
              <div><span id="statusTxt">â€”</span></div>
            </div>
            <div class="v" id="countsTxt">â€”</div>
          </div>
        </div>
        <div class="col">
          <div class="kpi">
            <div>
              <b>Ù…Ø³Ø§Ø¹Ø¯Ø© Ø³Ø±ÙŠØ¹Ø©</b>
              <div><span>Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ© (Ù„Ø§ ÙŠÙˆØ¬Ø¯ assets).</span></div>
            </div>
            <div class="v">âœ…</div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast"></div>
  </div>

<script>
const APP_KEY = "payrollApp_v1";
const SESSION_KEY = "payrollSession_v1";

function nowISODate(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function ymFromDateStr(dateStr){ return dateStr.slice(0,7); }
function fmtMoney(n){ 
  n = Number(n||0);
  return new Intl.NumberFormat("ar-EG",{maximumFractionDigits:2}).format(n);
}
function pad2(n){ return String(n).padStart(2,"0"); }
function minutesToHM(min){
  min = Math.max(0, Math.round(min||0));
  const h = Math.floor(min/60);
  const m = min%60;
  return `${h}:${pad2(m)}`;
}
function hmToMinutes(hm){
  if(!hm) return null;
  const m = /^(\d{1,2}):(\d{2})$/.exec(hm.trim());
  if(!m) return null;
  return (+m[1])*60 + (+m[2]);
}
function clamp(n,a,b){ return Math.min(b, Math.max(a,n)); }

function toast(type, title, msg){
  const wrap = document.querySelector(".toast");
  if(!wrap) return alert(`${title}\n${msg||""}`);
  const el = document.createElement("div");
  el.className = `t ${type==="ok"?"ok":"err"}`;
  el.innerHTML = `
    <div>
      <b>${escapeHtml(title)}</b>
      <div><span>${escapeHtml(msg||"")}</span></div>
    </div>
    <button aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
  `;
  el.querySelector("button").onclick = ()=> el.remove();
  wrap.appendChild(el);
  setTimeout(()=>{ if(el.isConnected) el.remove(); }, 5200);
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function loadDB(){
  const raw = localStorage.getItem(APP_KEY);
  if(!raw){
    const init = {
      version:1,
      company:{companyName:"", companyLogo:""},
      departments:[],
      employees:[],
      managers:[],
      monthSettings:{},
      attendance:{}, // { "YYYY-MM-DD": { "empId": record } }
      advances:{} // { "YYYY-MM": { "empId": {amount,note} } }
    };
    localStorage.setItem(APP_KEY, JSON.stringify(init));
    return init;
  }
  try{ return JSON.parse(raw); }catch(e){
    console.error(e);
    localStorage.removeItem(APP_KEY);
    return loadDB();
  }
}
function saveDB(db){ localStorage.setItem(APP_KEY, JSON.stringify(db)); }
function uid(prefix="id"){
  return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
}

function getSession(){
  const raw = localStorage.getItem(SESSION_KEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}
function setSession(obj){ localStorage.setItem(SESSION_KEY, JSON.stringify(obj)); }
function clearSession(){ localStorage.removeItem(SESSION_KEY); }

function requireAuth(allowedRoles){
  const s = getSession();
  if(!s || !allowedRoles.includes(s.role)){
    window.location.href = "index.html";
    return null;
  }
  return s;
}

function setBrand(db, roleLabel){
  const name = db.company.companyName || "Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆØ§Ù… ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨";
  const logo = db.company.companyLogo || "";
  const elName = document.querySelector("[data-company-name]");
  const elLogo = document.querySelector("[data-company-logo]");
  const elRole = document.querySelector("[data-role]");
  if(elName) elName.textContent = name;
  if(elRole) elRole.textContent = roleLabel;
  if(elLogo){
    if(logo){
      elLogo.innerHTML = `<img alt="Ø´Ø¹Ø§Ø±" src="${logo}">`;
    }else{
      elLogo.innerHTML = `<span style="font-weight:800;color:rgba(255,255,255,.65)">ğŸŸ©</span>`;
    }
  }
}

function wireTabs(){
  const tabs = [...document.querySelectorAll(".tab")];
  const sections = [...document.querySelectorAll(".section")];
  tabs.forEach(t=>{
    t.addEventListener("click", ()=>{
      const id = t.getAttribute("data-tab");
      tabs.forEach(x=>x.classList.toggle("active", x===t));
      sections.forEach(s=>s.classList.toggle("active", s.id===id));
      window.scrollTo({top:0,behavior:"smooth"});
    });
  });
  const first = tabs.find(t=>t.classList.contains("active")) || tabs[0];
  if(first) first.click();
}

function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function downloadCSV(filename, rows){
  const csv = rows.map(r=> r.map(v=>{
    const s = String(v ?? "");
    const needs = /[",\n\r]/.test(s);
    return needs ? `"${s.replaceAll('"','""')}"` : s;
  }).join(",")).join("\r\n");
  downloadText(filename, "\ufeff"+csv);
}
function parseCSV(text){
  const rows = [];
  let i=0, cur="", row=[], inQ=false;
  while(i < text.length){
    const ch = text[i];
    if(inQ){
      if(ch === '"'){
        if(text[i+1] === '"'){ cur+='"'; i+=2; continue; }
        inQ=false; i++; continue;
      }else{ cur+=ch; i++; continue; }
    }else{
      if(ch === '"'){ inQ=true; i++; continue; }
      if(ch === ','){ row.push(cur); cur=""; i++; continue; }
      if(ch === '\n'){
        row.push(cur); cur="";
        rows.push(row); row=[];
        i++; continue;
      }
      if(ch === '\r'){ i++; continue; }
      cur+=ch; i++; continue;
    }
  }
  row.push(cur);
  if(row.length>1 || row[0]!=="" ) rows.push(row);
  return rows;
}

function weekdayAr(dateStr){
  const d = new Date(dateStr+"T00:00:00");
  const names = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
  return names[d.getDay()];
}

function getMonthSetting(db, ym){
  return db.monthSettings?.[ym] || null;
}
function inferDaysInMonth(ym){
  const [y,m] = ym.split("-").map(Number);
  return new Date(y, m, 0).getDate();
}

function computeDerived(db, dateStr, empId, checkIn, checkOut, excuseType){
  const ym = ymFromDateStr(dateStr);
  const ms = getMonthSetting(db, ym);
  if(!ms) return {lateMinutes:0, earlyLeaveMinutes:0, overtimeMinutes:0, warn:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±"};
  const shiftStartM = hmToMinutes(ms.shiftStart);
  const shiftEndM = hmToMinutes(ms.shiftEnd);
  const inM = hmToMinutes(checkIn);
  const outM = hmToMinutes(checkOut);

  let late=0, early=0, ot=0;
  if(inM != null && shiftStartM != null){
    const grace = Number(ms.lateGraceMinutes||0);
    late = Math.max(0, inM - (shiftStartM + grace));
  }
  if(outM != null && shiftEndM != null){
    const graceE = Number(ms.earlyLeaveGraceMinutes||0);
    early = Math.max(0, (shiftEndM - graceE) - outM);
    ot = Math.max(0, outM - shiftEndM);
  }
  if(excuseType === "late_excused") late = 0;
  if(excuseType === "early_excused") early = 0;
  if(excuseType === "absent_excused"){ late=0; early=0; ot=0; }
  return {lateMinutes:Math.round(late), earlyLeaveMinutes:Math.round(early), overtimeMinutes:Math.round(ot), warn:null};
}

function getAttendanceRecord(db, dateStr, empId){
  return db.attendance?.[dateStr]?.[empId] || null;
}
function setAttendanceRecord(db, dateStr, empId, rec){
  if(!db.attendance[dateStr]) db.attendance[dateStr] = {};
  db.attendance[dateStr][empId] = rec;
}
function deleteAttendanceRecord(db, dateStr, empId){
  if(db.attendance?.[dateStr]?.[empId]) delete db.attendance[dateStr][empId];
  if(db.attendance?.[dateStr] && Object.keys(db.attendance[dateStr]).length===0) delete db.attendance[dateStr];
}

function getAdvance(db, ym, empId){
  return db.advances?.[ym]?.[empId] || {amount:0,note:""};
}
function setAdvance(db, ym, empId, obj){
  if(!db.advances[ym]) db.advances[ym] = {};
  db.advances[ym][empId] = {amount:Number(obj.amount||0), note:String(obj.note||"")};
}

function calcPayrollForEmployee(db, ym, emp){
  const ms = getMonthSetting(db, ym);
  const days = ms?.daysInMonth ? Number(ms.daysInMonth) : inferDaysInMonth(ym);
  const workHours = Number(ms?.workHoursInMonth||0);
  const hourValue = workHours>0 ? (Number(emp.monthlySalary||0)/workHours) : 0;

  const multipliers = {
    late: Number(ms?.latePenaltyMultiplier || 1.5),
    early: Number(ms?.earlyPenaltyMultiplier || 1.0),
    ot: Number(ms?.overtimeMultiplier || 1.0),
  };

  let totalLateMin=0, totalEarlyMin=0, totalOtMin=0;
  for(let d=1; d<=days; d++){
    const dateStr = `${ym}-${pad2(d)}`;
    const r = getAttendanceRecord(db, dateStr, emp.id);
    if(r){
      totalLateMin += Number(r.lateMinutes||0);
      totalEarlyMin += Number(r.earlyLeaveMinutes||0);
      totalOtMin += Number(r.overtimeMinutes||0);
    }
  }

  const lateDeduction = (totalLateMin/60)*hourValue*multipliers.late;
  const earlyDeduction = (totalEarlyMin/60)*hourValue*multipliers.early;
  const otValue = (totalOtMin/60)*hourValue*multipliers.ot;

  const adv = getAdvance(db, ym, emp.id);
  const advances = Number(adv.amount||0);

  const net = Number(emp.monthlySalary||0) + otValue - lateDeduction - earlyDeduction - advances;

  return {
    ym, days, workHours, hourValue,
    totalLateMin, totalEarlyMin, totalOtMin,
    lateDeduction, earlyDeduction, otValue,
    advances, net, multipliers
  };
}

function openPayslipPrintWindow(db, ym, emp){
  const dep = db.departments.find(d=>d.id===emp.departmentId);
  const depName = dep ? dep.name : "â€”";
  const ms = getMonthSetting(db, ym);
  const days = ms?.daysInMonth ? Number(ms.daysInMonth) : inferDaysInMonth(ym);
  const logo = db.company.companyLogo || "";
  const company = db.company.companyName || "â€”";

  const pay = calcPayrollForEmployee(db, ym, emp);

  const rows = [];
  for(let d=1; d<=days; d++){
    const dateStr = `${ym}-${pad2(d)}`;
    const r = getAttendanceRecord(db, dateStr, emp.id);
    if(r){
      rows.push(`
        <tr>
          <td>${escapeHtml(dateStr)}</td>
          <td>${escapeHtml(weekdayAr(dateStr))}</td>
          <td>${escapeHtml(r.checkIn||"")}</td>
          <td>${escapeHtml(r.checkOut||"")}</td>
          <td>${escapeHtml(minutesToHM(r.overtimeMinutes||0))}</td>
          <td>${escapeHtml(minutesToHM(r.lateMinutes||0))}</td>
          <td>${escapeHtml(minutesToHM(r.earlyLeaveMinutes||0))}</td>
        </tr>
      `);
    }
  }

  const html = `
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ØµÙƒ Ù‚Ø¨Ø¶ - ${escapeHtml(emp.name)}</title>
<style>
  body{font-family:Tahoma,Arial,sans-serif;margin:0;background:#fff;color:#111}
  .page{padding:24px 28px}
  .top{display:flex;align-items:center;justify-content:space-between;gap:16px;border-bottom:2px solid #111;padding-bottom:14px}
  .logo{width:60px;height:60px;border:1px solid #ddd;border-radius:12px;overflow:hidden;display:grid;place-items:center}
  .logo img{width:100%;height:100%;object-fit:cover}
  h1{margin:0;font-size:20px}
  .meta{margin-top:8px;color:#333;font-size:13px;line-height:1.7}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{border:1px solid #ddd;padding:8px;font-size:12px;text-align:right}
  th{background:#f3f4f6}
  .sum{margin-top:14px;border:1px solid #ddd;border-radius:10px;padding:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .line{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #e5e7eb}
  .line:last-child{border-bottom:0}
  .sig{display:flex;justify-content:space-between;margin-top:26px}
  .sig .box{width:46%;border-top:1px solid #111;padding-top:10px;text-align:center;font-size:13px}
  @media print{ .noPrint{display:none} .page{padding:14mm} }
</style>
</head>
<body>
  <div class="page">
    <div class="top">
      <div class="logo">${logo?`<img src="${logo}" alt="Ø´Ø¹Ø§Ø±">`:""}</div>
      <div style="flex:1">
        <h1>${escapeHtml(company)} â€” ØµÙƒ Ù‚Ø¨Ø¶ Ø±Ø§ØªØ¨</h1>
        <div class="meta">
          <div><b>Ø§Ù„Ù…ÙˆØ¸Ù:</b> ${escapeHtml(emp.name)} â€” <b>Ø§Ù„Ù‚Ø³Ù…:</b> ${escapeHtml(depName)}</div>
          <div><b>Ø§Ù„Ø´Ù‡Ø±:</b> ${escapeHtml(ym)}</div>
        </div>
      </div>
      <button class="noPrint" onclick="window.print()" style="padding:10px 14px;border:1px solid #111;background:#111;color:#fff;border-radius:10px;cursor:pointer">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„ÙŠÙˆÙ…</th>
          <th>Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
          <th>Ø§Ù„Ø®Ø±ÙˆØ¬</th>
          <th>Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</th>
          <th>Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
          <th>Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ±</th>
        </tr>
      </thead>
      <tbody>
        ${rows.join("") || `<tr><td colspan="7" style="text-align:center;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</td></tr>`}
      </tbody>
    </table>

    <div class="sum">
      <div class="grid">
        <div class="line"><span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</span><b>${minutesToHM(pay.totalOtMin)} â€” ${fmtMoney(pay.otValue)}</b></div>
        <div class="line"><span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ£Ø®ÙŠØ±</span><b>${minutesToHM(pay.totalLateMin)} â€” ${fmtMoney(pay.lateDeduction)}</b></div>
        <div class="line"><span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…Ø¨ÙƒØ±</span><b>${minutesToHM(pay.totalEarlyMin)} â€” ${fmtMoney(pay.earlyDeduction)}</b></div>
        <div class="line"><span>Ø§Ù„Ø³Ù„Ù</span><b>${fmtMoney(pay.advances)}</b></div>
        <div class="line" style="grid-column:1/-1;border-top:1px solid #e5e7eb;padding-top:10px">
          <span><b>Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</b></span><b style="font-size:16px">${fmtMoney(pay.net)}</b>
        </div>
      </div>
    </div>

    <div class="sig">
      <div class="box">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù</div>
      <div class="box">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
    </div>
  </div>
</body>
</html>
  `.trim();

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

function ensureSeedData(db){
  if(db.departments.length===0 && db.employees.length===0 && db.managers.length===0 && !db.company.companyName){
    db.company.companyName = "Ø´Ø±ÙƒØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ©";
    const depId = uid("dep");
    db.departments.push({id:depId, name:"Ø¥Ø¯Ø§Ø±Ø©"});
    db.employees.push({id:uid("emp"), name:"Ù…ÙˆØ¸Ù ØªØ¬Ø±ÙŠØ¨ÙŠ", departmentId:depId, monthlySalary:3000, active:true, notes:""});
    const ym = nowISODate().slice(0,7);
    db.monthSettings[ym] = {
      daysInMonth: inferDaysInMonth(ym),
      workHoursInMonth: 240,
      shiftStart:"09:00",
      shiftEnd:"17:00",
      lateGraceMinutes:10,
      earlyLeaveGraceMinutes:10,
      latePenaltyMultiplier:1.5,
      earlyPenaltyMultiplier:1.0,
      overtimeMultiplier:1.25
    };
    saveDB(db);
  }
}
</script>
<script>
(function(){
  const db = loadDB();
  ensureSeedData(db);
  setBrand(db, "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
  renderEmployeesList();

  const statusTxt = document.getElementById("statusTxt");
  const countsTxt = document.getElementById("countsTxt");
  statusTxt.textContent = "Ø¬Ø§Ù‡Ø²";
  countsTxt.textContent = `${db.employees.length} Ù…ÙˆØ¸Ù â€” ${db.departments.length} Ù‚Ø³Ù… â€” ${db.managers.length} Ù…Ø¯ÙŠØ±`;

  document.getElementById("loginAdminBtn").addEventListener("click", ()=>{
    const role = document.getElementById("roleSelect").value;
    const u = document.getElementById("u").value.trim();
    const p = document.getElementById("p").value;

    if(role === "admin"){
      if(u === "admin" && p === "admin123"){
        setSession({role:"admin", username:"admin"});
        window.location.href = "admin.html";
      }else{
        toast("err","Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©","ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.");
      }
      return;
    }

    const m = db.managers.find(x=>x.username===u && x.password===p);
    if(!m){
      toast("err","Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©","Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¯ÙŠØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      return;
    }
    setSession({role:"manager", username:m.username, managerId:m.id});
    window.location.href = "manager.html";
  });

  document.getElementById("loginEmpBtn").addEventListener("click", ()=>{
    const name = document.getElementById("empName").value.trim();
    if(!name){ toast("err","Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù",""); return; }
    const emp = db.employees.find(e=>e.name===name && (e.active!==false));
    if(!emp){
      toast("err","Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯","ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ø§Ø¨Ù‚Ù‹Ø§ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†.");
      return;
    }
    setSession({role:"employee", employeeId:emp.id, employeeName:emp.name});
    window.location.href = "employee.html";
  });

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    if(!confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
    localStorage.removeItem(APP_KEY);
    localStorage.removeItem(SESSION_KEY);
    toast("ok","ØªÙ…Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø©","Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
    setTimeout(()=>location.reload(), 600);
  });

  function renderEmployeesList(){
    const list = document.getElementById("empList");
    list.innerHTML = "";
    db.employees
      .filter(e=>e.active!==false)
      .sort((a,b)=>a.name.localeCompare(b.name,'ar'))
      .forEach(e=>{
        const o = document.createElement("option");
        o.value = e.name;
        list.appendChild(o);
      });
  }
})();
</script>
</body>
</html>
